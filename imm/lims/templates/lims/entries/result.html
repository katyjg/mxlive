{% load zip %}

<div id="view-images" class="hidden modal-content"></div>

<div id="result-page">
    <div id="result-title" class="floatleft size60">
    {% ifequal object.kind object.RESULT_TYPES.SCREENING %}
        <h2> Crystal Screening Report</h2>
    {% else %}
        <h2> Data Processing Report</h2>
    {% endifequal %}
    </div>

    <div id="result-links" class="floatright">
        <ul>
            <li>Crystal: &nbsp;<a href={% url lims-crystal-detail object.crystal.id %}>{{object.crystal}}</a></li>
            <li>Experiment: &nbsp;<a href={% url lims-experiment-detail object.experiment.id %}>{{object.crystal}}</a></li>
            <li>Dataset: &nbsp;<a href={% url lims-dataset-detail object.data.id %}>{{object.data}}</a></li>
            <li>Images: &nbsp;<a class="modal" rel="#view-images"  href="{{ object.data.url }}/{{ object.data.id }}">view images</a></li>
        </ul>
    </div>

    <div class="clear"></div>

    {% if object.is_resubmittable %}
        <a class="add-tool" href='/lims/experiment/result/{{object.get_results_link}}'>Resubmit</a>
    {% endif %}

    <h3>Summary</h3>
    <div id="result-summary">
        <table id="result-table">
            <colgroup>
                <col class='result-labels' />
            </colgroup>
            <thead>
                <tr>
                    <th scope="col">Dataset</th>
                    <th scope="col">&ldquo;{{object.name}}&rdquo;</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>Score<sup class="footnote">[1]</sup></td><td>{{object.score|floatformat:"-2"}}</td></tr>
                <tr><td>Wavelength (A)</td><td>{{object.data.wavelength}}</td></tr>
                <tr><td>Space Group<sup class="footnote">[2]</sup></td><td>{{object.space_group.name}} </td></tr>
                <tr><td>Unit Cell (A)</td><td>{{object.cell_a|floatformat:"-2"}} {{object.cell_b|floatformat:"-2"}} {{object.cell_c|floatformat:"-2"}}
                {{object.cell_alpha|floatformat:"-1"}} {{object.cell_beta|floatformat:"-1"}} {{object.cell_gamma|floatformat:"-1"}}</td></tr>
                <tr><td>Resolution (A)<sup class="footnote">[3]</sup></td><td>{{object.resolution|floatformat:"-2"}}</td></tr>
                <tr><td>All Reflections</td><td>{{object.reflections}}</td></tr>
                <tr><td>Unique Reflections</td><td>{{object.unique}}</td></tr>
                <tr><td>Multiplicity</td><td>{{object.multiplicity|floatformat:"-1"}}</td></tr>
                <tr><td>Completeness</td><td>{{object.completeness|floatformat:"-2"}} %</td></tr>
                <tr><td>Mosaicity</td><td>{{object.mosaicity}}</td></tr>
                <tr><td>I/Sigma(I)</td><td>{{object.i_sigma}}</td></tr>
                <tr><td>R-meas<sup class="footnote">[4]</sup></td><td>{{object.r_meas}}</td></tr>
                <tr><td>R-mrgd-F<sup class="footnote">[5]</sup></td><td>{{object.r_mrgd}}</td></tr>
                <tr><td>Spot deviation</td><td>{{object.sigma_spot}}</td></tr>
                <tr><td>Spindle deviation</td><td>{{object.sigma_angle}}</td></tr>
                {% ifnotequal object.ice_rings -1 %}
                    <tr><td>Ice Rings</td><td>{{object.ice_rings}}</td></tr>
                {% endifnotequal %}
            </tbody>
        </table>
    </div>

    <div class="tablenotes floatright size30">
        <h3>Notes</h3>
            <dl class="note-list">
            <dt>[1] -<dt>
            <dd>
                Data Quality Score for comparing similar data sets. Typically, values >
                0.8 are excellent, > 0.6 are good, > 0.5 are acceptable, > 0.4
                marginal, and &lt; 0.4 are Barely usable
            </dd>
            <dt>[2] -<dt>
            <dd>
                This space group was automatically assigned using POINTLESS (see P.R.Evans,
                Acta Cryst. D62, 72-82, 2005). This procedure is unreliable for incomplete datasets
                such as those used for screening. Please Inspect the detailed results below.
            </dd>
            <dt>[3] -<dt>
            <dd>
                Resolution selected based on a cut-off of I/sigma(I) > 1.0. Statistics presented
                reflect this resolution.
            </dd>
            <dt>[4] -<dt>
            <dd>Redundancy independent R-factor. (see Diederichs & Karplus, 1997, Nature Struct. Biol. 4, 269-275.)</dd>
            <dt>[5] -<dt>
            <dd>Quality of amplitudes. (see Diederichs & Karplus, 1997, Nature Struct. Biol. 4, 269-275.)</dd>
        </dl>
    </div>

    <div class="clear spacer"></div>

    <h3>Compatible bravais lattice types</h3>
    <table class="rtable full">
        <thead>
            <tr>
                <th scope="col">No.</th>
                <th scope="col">Lattice type</th>
                <th scope="col">Cell Parameters</th>
                <th scope="col">Quality</th>
                <th scope="col">Cell Volume</th>
            </tr>
        </thead>
        <tbody>
        {% with object.details.compatible_lattices as lattices %}
        {% zip lattices.id  lattices.type  lattices.unit_cell lattices.quality lattices.volume as tbl %}
        {% for rows in tbl %}
            <tr>
                <td>{{rows.0}}</td>
                <td>{{rows.1}}</td>
                <td>{{rows.2}}</td>
                <td>{{rows.3}}</td>
                <td>{{rows.4|floatformat:"-1"}}</td>
            </tr>
        {% endfor %}
        {% endwith %}
        </tbody>
    </table>

    <h3>Automatic Space-Group Selection</h3>
    <div class="tablenotes floatleft half">
        <h3>Notes</h3>
        <p>The following table contains result from POINTLESS (see Evans, Acta Cryst. D62, 72-82, 2005). </p>

        <p>Indistinguishable space groups will have similar probabilities. If two or more of the top candidates have the same probability, the one with the fewest symmetry assumptions is chosen. This usually corresponds to the point group,  trying out higher symmetry space groups within the top tier does not require re-indexing the data as they are already in the same setting. </p>

        <p>For more detailed results, please inspect the output file &lsquo;pointless.log&rsquo;.</p>
    </div>

    <table class="rtable floatright size45">
        <thead>
            <tr>
                <th scope="col">Selected</th>
                <th scope="col">Candidates</th>
                <th scope="col">Space Group No.</th>
                <th scope="col">Probability</th>
            </tr>
        </thead>
        <tbody>
        {% with object.details.spacegroup_selection as spacegroups %}
        {% zip spacegroups.name  spacegroups.space_group  spacegroups.probability as tbl %}
        {% for rows in tbl %}
            <tr>
            <td>
            {% ifequal forloop.counter 1 %}
            *
            {% endifequal %}
            </td>
                <td>{{rows.0}}</td>
                <td>{{rows.1}}</td>
                <td>{{rows.2|floatformat:"-1"}}</td>
            </tr>
        {% endfor %}
        {% endwith %}
        </tbody>
        <tfoot>
        <tr><td colspan=4></td></tr>
        </tfoot>
    </table>

    <div class="clear spacer"></div>

    <h3>Integration and Scaling Statistics (by shell)</h3>
    <table class="rtable floatleft size40">
        <thead>
            <tr>
                <th scope="col">Shell</th>
                <th scope="col">Complete</th>
                <th scope="col">R<sub>meas</sub></th>
                <th scope="col">R<sub>mrgd-F</sub></th>
                <th scope="col">I/sigma(I)<sup class="footnote">[1]</sup></th>
                <th scope="col">Sig<sub>ano</sub><sup class="footnote">[2]</sup></th>
            </tr>
        </thead>
        <tbody>
        {% with object.details.shell_statistics as stats %}
        {% zip stats.shell  stats.completeness  stats.r_meas stats.r_mrgdf stats.i_sigma stats.sig_ano as tbl %}
        {% for rows in tbl %}
            <tr>
            {% for col in rows %}
                <td>{{col|floatformat:"2"}}</td>
            {% endfor %}
            </tr>
        {% endfor %}
        {% endwith %}
        </tbody>
        <tfoot>
        <tr><td colspan=4></td></tr>
        </tfoot>
    </table>
    <image class="floatright" src={% url lims-plot-shells object.id %} />

    <div class="tablenotes floatright size45">
        <h3>Notes</h3>
        <dl class="note-list">
            <dt>[1] -<dt>
            <dd>
                Mean of intensity/Sigma(I) of unique reflections
                (after merging symmetry-related observations). Where Sigma(I) is
                the standard deviation of reflection intensity I estimated from sample statistics.
            </dd>
            <dt>[2] -<dt>
            <dd>
                mean anomalous difference in units of its estimated standard
                deviation (|F(+)-F(-)|/Sigma). F(+), F(-) are structure factor estimates
                obtained from the merged intensity observations in each parity class.
            </dd>
        </dl>
    </div>

    <div class="clear spacer"></div>

    <h3>Integration and Scaling Statistics (by frame/frame difference)</h3>
    <image class="floatleft" src={% url lims-plot-frames object.id %} />
    <image class="floatright" src={% url lims-plot-diffs object.id %} />

    <div class="clear"></div>

    <div class="tablenotes">
        <h3>Notes</h3>
        <dl class="note-list">
            <dt>Divergence -<dt>
            <dd>Estimated Standard Deviation of Beam divergence</dd>
            <dt>R<sub>d</sub> -<dt>
            <dd>R-factors as a function of frame difference. See Diederichs K. (2006) Acta Cryst D62, 96-101.</dd>
        </dl>
    </div>

    <div class="clear spacer"></div>

</div>
