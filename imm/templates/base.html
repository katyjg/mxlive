<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
    <head>
        <title>
            {% block title %}
                {% if user.is_superuser %}
                   Staff | {{ title|escape }}
                {% else %}
                   {{ project.name }} | {{ title|escape }}
                {% endif %}
            {% endblock %}
        </title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="robots" content="NONE,NOARCHIVE" />
        <script src="/js/modalpopup_builtin.js"></script>
        <script src="/js/jquery-1.4.2.min.js"></script>
        <script src="/js/jquery-ui-1.8.5.custom.min.js"></script>
        <script src="/js/jquery.jgrowl_minimized.js"></script>
        <script src="/js/jquery.form.js"></script>
        <script src="/js/jquery.tablednd_0_5.js"></script>
        <script src="/js/jquery.easing.1.3.js" type="text/javascript"></script>
        <script src="/js/jquery.slideviewer.1.2.js" type="text/javascript"></script> 

        {% comment %}
            As we add more scripts if this starts to get unruly it might make sense to integrate the YUI Loader pattern.
        {% endcomment %}
        <script>
            $.noConflict(); // puts jquery into noconflict mode as the prototype library utilizes the $ namespace.
        </script>
        <script src="/js/jquery.lightbox_me.js"></script>
        <script src="/js/prototype.js"></script>
        <script src="/js/ajax.js"></script>
        {% block stylesheet %}
            <link rel="stylesheet" href="/css/main.css" />
            <link rel="stylesheet" href="/css/jquery.jgrowl.css" />
            <link rel="stylesheet" href="/css/slideview.css" />
        {% endblock %}
        {% block extrastyle %}{% endblock %}
    </head>

    <body class="{% block bodyclass %}{% endblock %}">
        <div id="container">

            {% block content-override %}

                <div id="header" >
                    <a href="/" class="logo"><img src="/img/header.logo.png" alt="Canadian Light Source"/></a>
                    <h1>
                        <span class="title">Canadian Macromolecular Crystallography Facility</span>
                        <span class="subtitle">Laboratory Information Management System.</span>
                    </h1>
                    <span id="user-tools">
                        {% if user.is_superuser %}
                            <a href="/admin/">Site Admin</a> |
                        {% endif %}
                            <a class="modal" rel="#help-modal" href="/help/">Help</a> |
                            <div id="help-modal" class="hidden modal-content"></div>
                        {% if user.is_authenticated %}
                            <a href="/logout/">Sign out</a>
                        {% else %}
                            <a href="/login/">Sign in</a>
                        {% endif %}
                    </span>
                    
                </div><!-- end header -->

                <div id="subcontainer">
                    <div id="navigation">
                        <div class="project-info">LIMS</div>
                        {% block nav-main %}
                            {% if user.is_superuser %}
                                {%include "lims/staff_navs.html" %}
                            {% else %}
                                {%include "lims/project_navs.html" %}
                            {% endif %}
                        {% endblock %}
                        {% block activity %}{% endblock %}
                    </div><!-- end navigation -->

                    <div id="content">
                        {# moving this block here temporarily #}
                        {% block nav-sub %}{% endblock %}
                        {% if messages %}
                            <script>
                                {% for msg in messages %}
                                    jQuery.jGrowl("{{msg|escape}}");
                                {% endfor %}
                            </script>
                        {% endif %}
                        {% block content %}
                            {{ content }}
                        {% endblock %}
                    </div><!-- end maincol -->

                    <div id="sidebar">
                        {% block sidebar %}
                            {% include "lims/activity_log.html" %}
                        {% endblock %}
                    </div><!-- end sidebar -->
                </div><!-- end subcontainer -->

                <div id="footer">
                    {% block footer %}
                        <p>&copy;2008 Canadian Light Source, Inc. - <a href="http://www.lightsource.ca">CLS Home</a> - <a href="http://ex.lightsource.ca/cmcf/">CMCF Home</a> - <a href="/privacy/">Privacy Policy</a></p>
                    {% endblock %}
                </div><!-- end footer -->

            {% endblock %}

        </div><!-- end container -->

        <div id="popup-window"></div><!-- end popup-window -->

        {% block script %}
        
            <script>

                // TODO: add generic way to overlay a loading indicator on widgets and datalists.

                function loadWidgets() {
                    jQuery(".widget").each(function(i, widget) {
                        var $widget = jQuery(widget);
                        $widget.find("ul").load($widget.attr("data"), function() {});
                    });
                }

                function loadDatalists() {
                    jQuery(".datalist").each(function(i, datalist) {
                        var $datalist = jQuery(datalist);
                        $datalist.load($datalist.attr("data"), function() {
                            // check to see if drag and drop needs to be setup for this datalist
                            if($datalist.hasClass("requires-dragdrop")) {
                                setupTableDragAndDrop("#" + $datalist.attr("id"), $datalist.attr("data"));
                            }
                        });
                    });
                }

                function add(jQuery_droppable, jQuery_draggable) {
                    var droppableUrl = jQuery_droppable.attr("rel");
                    // I (Cody) broke this when I removed the href to avoid sidebar linkage
                    var parts = jQuery_draggable.children("a").attr("href").split("/");
                    var draggableId = parts.pop();
                    while ( draggableId == "" ) { draggableId = parts.pop(); }
                    var parent = jQuery_droppable.attr("parent");
                    var container_location = jQuery_droppable.attr("container_location");
                    jQuery.ajax({
                        type: "POST",
                        url: droppableUrl + "add/",
                        data: { items: draggableId, parent: parent, container_location: container_location },
                        dataType: "script",
                        success: function() {
                            loadWidgets();
                            // Maybe this is the call that should be removed. Need to just update datalist, not load it. 
                            // this does "fix" the collapsing views. Investigation what will be broken. 
                            // looks like it shouldn't be needed. 
                            // loadDatalists();
                        }
                    });
                }

                function remove(jQuery_draggable) {
                    var draggableUrl = jQuery_draggable.children().attr("href");
                    jQuery.ajax({
                        type: "POST",
                        url: draggableUrl + "remove/",
                        data: { "_confirmed": 1 },
                        dataType: "script",
                        success: function() {
                            loadWidgets();
                            // assuming this call is not needed, much like the add case. 
                            // loadDatalists();
                        },
                        error: function() {
                        	// if there is an error, reload the widget to reset state. 
                        	loadWidgets();
                        }
                        
                    });
                }

                function serialize(table) {
                    var rowIds = [];
                    var rows = table.tBodies[0].rows;
                    for (var i = 0; i < rows.length; i++) {
                        var jQuery_row = jQuery(rows[i]);
                        if ( jQuery_row.hasClass("link-row") ) {
                            rowIds.push("objlist-list-table[]=" + jQuery_row.attr("id"));
                        }
                    }
                    return rowIds.join("&");
                }

                function setupTableDragAndDrop(selector, url) {
                    var serializedAtStart;
                    jQuery(selector + " table").tableDnD({
                        onDragClass: "lims-droppable-active",
                        onDragStart: function(table, row) {
                            serializedAtStart = serialize(table);
                        },
                        onDrop: function(table, row) {
                            var serializedAtDrop = serialize(table);
                            if (serializedAtStart != serializedAtDrop) {
                                var jQuery_tr = jQuery(selector + " table tr#" + row.id);
                                jQuery.ajax({
                                    type: "POST",
                                    url: jQuery_tr.attr("rel") + "priority/",
                                    data: serializedAtDrop,
                                    success: function() {
                                        jQuery_tr.parents(".content-list").load(url, function() {
                                            setupTableDragAndDrop(selector, url);
                                        });
                                    }
                                });
                            }
                        }
                    });
                }

                function setupDragAndDrop() {
                    jQuery(".draggable-link-parent").draggable({
                        revert: "invalid"
                    });
                    jQuery(".droppable").droppable({
                        accept: function( jQuery_draggable ) {
                            return jQuery_draggable.hasClass(jQuery(this).attr("accept"));
                        },
                        drop: function( event, ui ) {
                            if (jQuery(this).hasClass("droppable-add")) {
                                add(jQuery(this), ui.draggable);
                            }
                            if (jQuery(this).hasClass("droppable-remove")) {
                                remove(ui.draggable);
                            }
                            jQuery("tr.expander.loaded").each( function() {
                                jQuery(this).children("td").load(jQuery(this).prev().attr("rel"), function() {});
                            });
                        },
                        activeClass: "lims-droppable-active",
                        hoverClass: "lims-droppable-hover",
                        tolerance: "pointer"
                    });
                }

                jQuery("#sidebar, #content").live("DOMSubtreeModified", function() { setupDragAndDrop();});

                loadWidgets();
                loadDatalists();

            </script>
        
        {% endblock %}
    </body>
</html>
