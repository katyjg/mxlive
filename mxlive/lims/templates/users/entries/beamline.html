{% extends "users/base.html" %}
{% load humanize %}
{% load markup %}
{% load static %}

{% load container_table %}

{% block page_heading %}
    <h3 class="text-condensed narrow-heading">
        <i class="text-muted fa fa-fw {% if object.is_editable %}fa-unlock{% else %}fa-lock{% endif %}"></i>
        <strong class="text-muted">{{ object.name }}</strong> | {{ object.active_automounter.kind }}
    </h3>
    <span class="text-muted">
        Beamline
    </span>
{% endblock %}

{% block object_tools %}
    {% if object.is_editable or object.is_deletable %}
        <div class="object-tools">
            <span class="box-tools pull-right">
                {% if object.is_editable %}
                    <a class="pull-right" data-url="{{ handler }}edit/">
                        <i class="fa fa-2 fa-fw fa-pencil"></i><br>
                        <span class="tool-label">Edit</span>
                    </a>
                {% endif %}
                {% if object.is_deletable %}
                    <a class="pull-right" data-url="{{ handler }}delete/">
                        <i class="fa fa-2 fa-fw fa-remove"></i><br>
                        <span class="tool-label">Delete</span>
                    </a>
                {% endif %}
            </span>
        </div>
    {% endif %}
{% endblock %}

{% block object_status %}
    <div class="status-bar">
        <div class="row">
            <div class="col-xs-6 col-sm-4">
                <h3 class="no-vmargin">
                    <span class="label label-info">{{ object.contact_phone }}</span>
                </h3>
            </div>
            <div class="col-xs-3 col-sm-4">
                <small class="text-muted text-condensed">Energy Range:</small><br>
                {{ object.energy_lo }} - {{ object.energy_hi }}
            </div>
            <div class="col-xs-3 col-sm-4 pull-right text-right">
                <small class="text-muted text-condensed">Comments:</small><br>
                {{ object.active_automounter.staff_comments }}
            </div>
        </div>
    </div>
{% endblock %}

{% block full %}
    {% with object.active_automounter as automounter %}
        <div id="admin-assign" class="col-sm-7">
            <h3>Automounter Layout</h3>
            <hr />
            <div id="layout-{{ automounter.pk }}" class="layout-lg"></div>
            {% include "users/entries/layout-container.html" with object=automounter.pk kind=automounter.kind %}
        </div>


    <div class="col-sm-5 col-xs-12">
        <h3>Loaded Containers</h3>
        <hr />
        <div class="list-group list-group-hover">
            {% for container in automounter.children.all %}
                <div class="list-group-item" id="container-{{ container.pk }}">
                    <span class="box-tools box-tools-inline pull-left" style="min-width: 40px;">
                        <span class="text-condensed text-large" style="padding-left: 0; padding-right: 0.25em;">{{ container.location }}</span>
                    </span>
                    <span class="box-tools pull-right">
                        <a class="pull-right" onclick="unload({{ container.pk }});" title="Unload Container">
                            <i class="fa fa-2 fa-fw fa-minus-circle"></i>
                            <br><span class="tool-label">Unload</span>
                            <form method="post" id="{{ container.pk }}-unload" action="{% url "container-unload" container.pk %}">
                                {% csrf_token %}
                                <input name="parent" type="hidden" />
                                <input name="location" type="hidden" />
                            </form>
                        </a>

                        <a class="pull-right" data-url="{% url "container-load" container.pk %}" title="Move Container">
                            <i class="fa fa-2 fa-fw fa-exchange"></i>
                            <br><span class="tool-label">Move</span>
                        </a>
                    </span>
                    <h4 class="list-group-item-heading overflow ellipsis"><a href="{% url "container-detail" pk=container.pk %}"><span class="text-muted">{{ container.project|upper }}</span> | <strong>{{ container.name }}</strong></a></h4>
                    <p class="list-group-item-text overflow ellipsis">
                        <span class="text-muted">{{ container.kind }} | </span><strong>{{ container.sample_set.count }}</strong> sample{{ container.sample_set.count|pluralize }}
                    </p>
                    {% if container.children.count %}
                        <small class="text-muted">
                         <table class="table table-hover">
                             <tr><th>Location</th>
                                 <th>Container</th>
                                 <th class="text-center">Samples</th>
                                 <th class="text-center">Move</th>
                                 <th class="text-center">Unload</th></tr>
                            {% for child in container.children.all %}
                                <tr id="container-{{ child.pk }}">
                                    <td>
                                        <strong>{{ container.location }}{{ child.location }}</strong>
                                    </td>
                                    <td><a href="{% url "container-detail" pk=child.pk %}"><span class="text-muted">{{ child.project|upper }}</span> | <strong>{{ child.name }}</strong></a>
                                    </td>
                                    <td class="text-center"><strong>{{ child.sample_set.count }}</strong></td>
                                    <td class="text-center">
                                        <a data-url="{% url "container-load" child.pk %}" title="Move Container">
                                            <i class="fa fa-2 fa-fw fa-exchange"></i>
                                        </a>
                                    </td>
                                    <td class="text-center">
                                        <a data-url="unload({{ child.pk }});" onclick="unload({{ child.pk }});" title="Unload Container">
                                            <i class="fa fa-2 fa-fw fa-minus-circle"></i>
                                        </a>
                                        <form method="post" id="{{ child.pk }}-unload" action="{% url "container-unload" child.pk %}">
                                            {% csrf_token %}
                                            <input name="parent" type="hidden" />
                                            <input name="location" type="hidden" />
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                         </table></small>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>

    <script src="{% static "jquery/jquery.form.min.js" %}"></script>
    <script>
        {% for container in automounter.children.all %}
            $('#container-{{ container.pk }}').hover(
            function() {
                $('#envelope-{{ container.parent.pk }}-{{ container.pk }}-{{ container.location }}').addClass('active-envelope');
            },
            function() {
                $('.active-envelope').removeClass('active-envelope');
            });
            $('#envelope-{{ container.parent.pk }}-{{ container.pk }}-{{ container.location }}').hover(function() {
                $('#container-{{ container.pk }}').addClass('active-envelope');
                $('#envelope-{{ container.parent.pk }}-{{ container.pk }}-{{ container.location }}').addClass('active-envelope');
            },
            function() {
                $('.active-envelope').removeClass('active-envelope');
            });
            {% for child in container.children.all %}
                $('#envelope-{{ container.pk }}-{{ child.location }}').hover(function() {
                    $('#container-{{ container.pk }}').addClass('active-envelope');
                    $('#envelope-{{ container.pk }}-{{ child.location }}').addClass('active-envelope');
                },
                function() {
                    $('.active-envelope').removeClass('active-envelope');
                });
            {% endfor %}

        {% endfor %}
        $('[accepts]').click(function() {
            var location = $(this).attr('id').split('-')[$(this).attr('id').split('-').length-1];
            var container = $(this).attr('id').split('-')[$(this).attr('id').split('-').length-2];
            $('#modal-form').load("/users/containers/"+container+'/location/'+location+'/');
        });

    function unload(e) {
        e.preventDefault;
        $(this).html('<i class="fa fa-spinner fa-spin"></i>');
        var form = $('form#'+e+'-unload');
        var url = form.attr('action');
        form.ajaxSubmit({
            type: 'post',
            url: url,
            success: function () {
                window.location.reload();
            },
            data: ""
        });
    }
    </script>

    {% endwith %}
{% endblock %}

{% block extra_js %}

{% endblock %}