{% extends "users/base.html" %}
{% load humanize %}
{% load markup %}

{% load image_url %}
{% load file_exists %}
{% load score_colors %}

{% block extra_css %}
    <link rel="stylesheet" href="/static/css/print.css" type="text/css" media="print"/>
{% endblock %}

{% block page_heading %}
    <h3 class="text-condensed narrow-heading overflow ellipsis">
        <i class="text-muted fa fa-fw {% if object.is_editable %}fa-unlock{% else %}fa-lock{% endif %}"></i>
        <span class="text-muted">{{ object.project|upper }}</span> | <strong>{{ object.name }}</strong>
    </h3>
    <span class="text-muted">
        Collection Protocol
    </span>
{% endblock %}

{% block object_tools %}
    <span class="box-tools pull-right">
        <a class="pull-right" href="{% url "shipment-detail" object.pk %}">
            <i class="fa fa-2 fa-f2 fa-bookmark"></i><br>
            <span class="tool-label">Shipment</span>
        </a>
    </span>
{% endblock %}

{% block object_status %}
    <div class="status-bar">
        <div class="row">
            <div class="col-xs-3">
                <small class="text-muted text-condensed">Samples:</small><br>
                {{ object.num_samples }}
            </div>
            <div class="col-xs-3">
                <small class="text-muted text-condensed">
                    <div class="label label-default" title="Show/Hide" style="cursor: pointer;" data-toggle="collapse" data-target="#containers" onclick="$(this).find('i').toggleClass('fa-compress');">
                        <i class="fa fa-fw fa-expand"></i>
                    </div>
                    &nbsp; Containers:</small><br>
                {{ object.container_set.count }}

            </div>
            <div class="col-xs-3">
                <small class="text-muted text-condensed">Groups:</small><br>
                {{ object.group_set.count }}
            </div>
            <div class="col-xs-3">
                <small class="text-muted text-condensed">Comments:</small><br>
                {{ object.comments }}
            </div>
        </div>
    </div>
{% endblock %}

{% block full %}

    <div class="collapse" id="containers">
        <div class="row">
        {% for container in shipment.container_set.all %}
            <div class="pull-left text-center">
                    <div id="layout-{{ container.pk }}" class="layout-lg">
                        <span class="pull-left">
                            <a href="{% url "container-detail" pk=container.pk %}">
                                <strong>{{ container.name }}</strong>
                            </a>
                        </span>
                    </div>
                    {% include "users/entries/layout-container.html" with object=container.pk kind=container.kind size=100 %}
            </div>
        {% endfor %}
        </div>
        <hr/>
    </div>

    <div class="row">
        <div class="col-xs-12">
            {% for group in shipment.group_set.all %}
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <div class="panel-title">
                            <span class="box-tools pull-right">
                                <a class="pull-right" data-toggle="collapse" data-target="#group-{{ group.pk }}" onclick="$(this).find('i').toggleClass('fa-expand').toggleClass('fa-compress');">
                                    <i class="fa fa-1 fa-compress"></i><br/>
                                    <span class="tool-label"><small>Show/Hide</small></span>
                                </a>
                            </span>
                            <h4>
                                <a href="{% url "group-detail" pk=group.pk %}">
                                    {% if group.name %}<span class="badge" title="Priority {{ group.priority }}">{{ group.priority }}</span> | {% endif %}<strong>{{ group.name }}</strong>
                                </a>

                                <span class="pull-right">
                                    <small><strong>{{ group.get_kind_display }}
                                        {% if group.absorption_edge or group.energy %}
                                            ({{ group.absorption_edge }}{% if group.absorption_edge and group.energy %} / {% endif %}
                                            {{ group.energy }}{% if group.energy %}keV{% endif %})
                                        {% endif %}</strong>/ {{ group.get_plan_display }}</small>
                                </span>
                            </h4>

                        </div>
                    </div>
                    {% if group.comments %}<div class="panel-body"><p>{{ group.comments }}</p></div>{% endif %}
                    <table class="table table-hover collapse in" id="group-{{ group.pk }}">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Location</th>
                                <th>Comments</th>
                                <th>Screening</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        {% for sample in group.sample_set.all %}
                            <tr class="hover-row" sample="{{ sample.name }}">
                                <td class="col-xs-2">
                                    <form method="post" id="{{ sample.pk }}-done" action="{% url "sample-done" sample.pk %}">
                                        {% csrf_token %}
                                        <input onchange="$('#{{ sample.pk }}-done').submit();" name="collect_status" pk="{{ sample.pk }}" {% if sample.collect_status %}checked{% endif %} type="checkbox"/>
                                        <label >&nbsp;<a href="{% url "sample-detail" sample.pk %}"><strong>{{ sample.name }}</strong></a></label>
                                    </form>
                                    </td>
                                <td class="col-xs-2">{{ sample.container.name }} - <strong>{{ sample.container_location }}</strong></td>
                                <td class="col-xs-2">{{ sample.comments|default_if_none:"" }}</td>
                                <td class="col-xs-2">
                                    <table class="subtable">
                                        <tr>
                                            <td>{% for data in sample.data_set.collection %}
                                                <a data-url="{% url "data-detail" data.pk %}"
                                                   class="{% ifequal data sample.best_overall.data %}stress{% endifequal %}">
                                                    {{ data.name }}
                                                </a>{% if data.score_label %}
                                                <a href="{% url "result-detail" data.result.pk %}"
                                                   class="{% ifequal data sample.best_overall.data %}stress{%endifequal %}">
                                                   ({{ data.score_label|color_score:2}})</a>{% endif %}<br> {% endfor %}
                                            </td>
                                        </tr>
                                    </table>
                                </td>
                            <td class="col-xs-4">
                                    {% for data in sample.data_set.collection %}
                                        {% if data|images_exist %}
                                            <div class="thumbnail data-thumbnail" style="margin-bottom: 0px; background-image: url({% image_url data 1 'lt' %});">
                                                <div class="overflow row">
                                                    <!--div class="col-xs-12 col-sm-6">
                                                        <a data-url="{% url "data-detail" data.pk %}"><img src="{% image_url data 1 "nm"  %}" /></a>
                                                    </div-->
                                                    <div class="col-xs-12 pull-right text-right text-condensed"><small>
                                                        <span class="box-tools pull-right">
                                                            <a data-url="{% url "data-edit" data.pk %}" title="Add/Edit Notes"><i class="fa fa-fw fa-comment-o"></i></a>
                                                        </span>
                                                        <h5 class="overflow ellipsis" style="padding-right: 15px; margin-top: 0.5em;"><strong>
                                                            <a data-url="{% url "data-detail" data.pk %}">{{ data.name }}</a></strong></h5>

                                                        <p>
                                                            <strong>{{ data.delta_angle }}&#176;</strong> / <strong>{{ data.exposure_time }}s</strong> per frame<br/>
                                                            <strong>{{ data.num_frames }} frames</strong> ({{ data.total_angle }}&#176; total)<br/>
                                                            <strong>{{ data.resolution }}&#8491;</strong> res. limit</p>
                                                        {% if data.staff_comments %}
                                                            <div class="alert alert-info" title="Notes" style="margin-bottom: 0px;">
                                                                {{ data.staff_comments|default_if_none:"" }}
                                                            </div>
                                                        {% endif %}
                                                    </small></div>
                                                </div>
                                            </div>
                                            <div class="thumbnail thumbnail-print" style="margin-bottom: 0px;">
                                                <strong>{{ data.name }}</strong>
                                                <p><span class="pull-left">
                                                    ({{ data.num_frames }} frames / {{ data.total_angle }}&#176; total)
                                                </span>
                                                <span class="pull-right">{{ data.resolution }}&#8491; res. limit</span>

                                                </p>
                                                {% if data.staff_comments %}
                                                    <div class="alert alert-info" title="Notes" style="margin-bottom: 0px;">
                                                        {{ data.staff_comments|default_if_none:"" }}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </td>
                            </tr>
                        {% endfor %}
                    </table>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <script>
        $('.table-hover tr').hover(function() {
            var sample = $(this).attr('sample');
            $('[sample="'+sample+'"]').addClass('active-sample');
        },
        function() {
            $('.active-sample').removeClass('active-sample')
        });
    </script>


{% endblock %}