{% load data_server %}
{% load static %}

<div id="data-viewer">
    <div class="row">
        <div class="col-xs-9" style="width: 542px;">
            <!-- image viewer aspect -->
            <div class="data-image">
                <div id="data-image-loading"><div></div></div>
                <div class="image-wrapper">
                    <div id="diffviewer" class="viewer"></div>
                </div>
                <!-- image navigation -->
                <div class="image-nav">
                    <div class="pull-left">
                        <button class="btn btn-success btn-dk" onclick="changeBrightness('dk');" type="button">Dark</button>
                        <button class="btn btn-success btn-nm" onclick="changeBrightness('nm');" type="button">Normal</button>
                        <button class="btn btn-success btn-lt" onclick="changeBrightness('lt');" type="button">Light</button>
                    </div>
                    <div class="pull-left loaded-image overflow"><span><var id="framename"></var></span><br/>Osc: <var id="oscstart"></var> to <var id="oscend"></var></div>
                    <div class="pull-right">
                        <button class="btn btn-info" onclick="prevClicked();" type="button"><i class="fa fa-fw fa-chevron-left"></i></button>
                        <button class="btn btn-info" onclick="nextClicked();" type="button"><i class="fa fa-fw fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row col-xs-3 col-meta">
            {% get_snapshot_url object as snapshot %}
            <!-- Display of metaData -->
            <div class="row">
                {% if snapshot %}
                    <div class="meta-data col-xs-12">
                        <div class="row">
                            <div class="xtal-pic col-xs-12" style="background-image: url('{{ snapshot }}');" title="Snapshot from beamline">&nbsp;</div>
                        </div>
                    </div>
                {% endif %}

                <div class="col-xs-12">
                    <ul class="nav nav-tabs text-condensed">
                        <li class="active"><a data-toggle="pill" href="#frames">{{ object.num_frames }} Frames ({{ object.frame_sets }})</a></li>
                        <li><a data-toggle="pill" href="#meta-data">Meta-Data</a></li>
                    </ul>
                </div>
                <div class="frame-list col-xs-12">
                    <!--h4 class="text-condensed">{{ object.num_frames }} Frames ({{ object.frame_sets }})</h4-->
                    <div class="tab-content">
                        <div id="frames" class="tab-pane fade active in">
                            <ul class="scrollbar-inner {% if not snapshot %}tall{% endif %}">
                                {% for frame_id in object.frames %}
                                    <li frame-id="{{ frame_id }}" frame-name="{% get_frame_name data frame_id %}">
                                        <a onclick="toFrame('{% get_frame_name data frame_id %}', {{ frame_id }});">{% get_frame_name data frame_id %}</a>&nbsp;
                                        <a class="pull-right download-tool" href="{% get_image_url object frame_id %}" title="Download this image"><i class="fa fa-fw fa-download"></i></a>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div id="meta-data" class="tab-pane fade">
                            <ul class="scrollbar-inner {% if not snapshot %}tall{% endif %}">
                                {% with data|get_meta_data as meta_data %}
                                    {% for k, v in meta_data.items %}
                                        <li><strong>{{ k|title }}: </strong> {{ v }}</li>
                                    {% endfor %}
                                {% endwith %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="{% static "css/jquery.diffviewer.css" %}" />

<script src="{% static "jquery/jquery-migrate.min.js" %}"></script>
<script src="{% static "js/jquery.mousewheel-3.0.6.js" %}"></script>
<script type="text/javascript" src="/static/js/jquery.diffviewer.js"></script>
<script type="text/javascript">
    var dataViewer = function(){

        var  loadingTimer, loadingFrame= 1;
        var  loading = $('#data-image-loading');
        var  wavelength = 1.0;
        var  ref_resol = 2.0;
        var  theta_m = Math.asin(0.5*wavelength)/ref_resol;

        function  _animate_loading() {
            if (!loading.is(':visible')){
                clearInterval(loadingTimer);
                return;
            }
            jQuery('div', loading).css('top', (loadingFrame * -40) + 'px');
            loadingFrame = (loadingFrame + 1) % 12;
        }

        return {
            setPars: function(w, r) {
                wavelength = w;
                ref_resol = r;
                theta_m = Math.asin(0.5*wavelength)/ref_resol;
            },
            calcRes: function(f) {
                return (0.5*wavelength)/Math.sin(f * theta_m)
            },
            showActivity: function() {
                loading = jQuery('#data-image-loading');
                clearInterval(loadingTimer);
                loading.show();
                loadingTimer = setInterval(_animate_loading, 66);
            },
            hideActivity: function() {
                loading.hide();
            }
        }
    }();

	var $current_frame_to_display = "{% get_frame_name object object.first_frame %}";
	var $current_frame_id = {{ object.first_frame }};
	var $current_brightness_to_display = 'nm';
	var $expanded_frame_set = {{ object.frames }};
    dataViewer.setPars({{object.wavelength}}, {{object.meta_data.resolution|default:0}});

    $('[data-target="#parameters"]').click(function(e){
        e.preventDefault();
        e.stopPropagation();
        var target = $($(this).attr('data-target'));
        var frame_list = $('.frame-list ul');
        var height = 0;
        if (target.hasClass('in')) {
            height = frame_list.height() + $('#parameters').height();
        }
        $(this).find('i').toggleClass('fa-compress');
        target.toggleClass('in');

        if (!(height > 0)) {
            height = frame_list.height() - $('#parameters').height();
        }
        frame_list.height(height);
    });

	function changeBrightness(brightness) {
		if (brightness == $current_brightness_to_display) {
			return;
		}
		$('.active-brightness').removeClass('active-brightness');
		$('.btn-'+brightness).addClass('active-brightness');
		$current_brightness_to_display = brightness;
        updateFrame();
	};

	function updateFrame() {
		url = '{% get_base_url object %}';
		url = url + $current_frame_to_display;
		var src;
        $.ajax({
            url: '{% url "fetch-image" %}',
            data: {
                'url': url,
                'brightness': $current_brightness_to_display
            },
            success: function (response) {
                if (response['src']) {
                    src = response['src']
                } else {
                    src = "/static/img/image-not-found.png";
                }
                $("#diffviewer").diffviewer('loadImage', src);
                updateFrameDetails();
                }
        });
	}

	$(document).ready( function() {
		$current_frame_to_display = "{% get_frame_name object object.first_frame %}";
		$current_frame_id = {{ object.first_frame }};
		$current_brightness_to_display = "nm";
		updateFrameDetails();
		var img_src = "{% get_image object object.first_frame 'nm' %}";
		if (!img_src) {
            img_src = "/static/img/image-not-found.png";
        }
		$expanded_frame_set = {{ object.frames }};
        $("#diffviewer").diffviewer({
            src: img_src,
            //update_on_resize: false,
            zoom: 50,
            zoom_min: 50,
            onStartLoad: function() {
                dataViewer.showActivity();
            },
            onFinishLoad: function() {
                $("#diffviewer").diffviewer('setCoords', -500, -500);
                dataViewer.hideActivity();
            },
            resFunc: function(r) {
                return dataViewer.calcRes(r);
            }
        });
        updateFrameDetails();
	});

	function updateFrameDetails() {
		// use jQuery to find and update the frame specific elements.
		element = $('#framename');
		element.text($current_frame_to_display);
        if (element.width() > parseInt($('.loaded-image').css('maxWidth'))) {
            $('.loaded-image').addClass('reverse-ellipsis');
        }

		osc = ($current_frame_id - {{object.first_frame}}) * {{object.meta_data.delta_angle|default:0}} + {{object.meta_data.start_angle|default:0}};
		$('#oscstart').text(osc + " deg");

		osc = osc + {{object.meta_data.delta_angle|default:0|floatformat:1}};
		$('#oscend').text(osc + " deg");

	}

	function nextClicked() {
		// get next frame in set.
        index = $.inArray($current_frame_id, $expanded_frame_set);
		if ((index != -1) && (index < $expanded_frame_set.length -1)) {
			index++;
			$current_frame_id = $expanded_frame_set[index];
            $current_frame_to_display = $('[frame-id="'+$current_frame_id+'"]').attr('frame-name');
            updateFrame();
		}
		return;
	}

	function prevClicked() {
		// get previous frame in set
		index = $.inArray($current_frame_id, $expanded_frame_set);
		if ((index != -1) && (index > 0)) {
			index--;
			$current_frame_id = $expanded_frame_set[index];
			$current_frame_to_display = $('[frame-id="'+$current_frame_id+'"]').attr('frame-name');
            updateFrame();
		}
		return;
	}

	function toFrame(frame, frame_id) {
        index = $.inArray(frame_id, $expanded_frame_set);
		if (index != -1) {
			$current_frame_to_display = frame;
			$current_frame_id = frame_id;
			updateFrame();
		}
		return;
	}
</script>