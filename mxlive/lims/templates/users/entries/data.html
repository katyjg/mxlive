{% extends "forms/modal.html" %}

{% load zip %}
{% load markup %}
{% load data_extras %}
{% load data_server %}
{% load file_exists %}
{% load static %}
{% load get_version %}
{% load score_colors %}

{% block modal_size %}modal-lg modal-data{% endblock %}

{% block form_title %}
    <span class="text-condensed">
        <span class="text-muted">
            {% if request.user.is_superuser %}{{ object.project }} | {% endif %}{{ object.identity }} | </span>
            <strong>{{ object.name }}</strong>
    </span>
        <!--div class="box-tools">
            <ul class="toolbar">
                {% if object.can_download %}
                <li class="download-tool" title="Download Archive">
                    <a href="/download/data/{{object.url}}/{{object.name}}.tar.gz" download="{{object.name}}.tar.gz" target="_blank">Download</a>
                </li>
                {% endif %}
            </ul>
        </div-->
{% endblock %}

{% block form_body %}

<div id="data-viewer">
    <div class="row">
        <div class="col-xs-9" style="width: 542px;">
            <!-- image viewer aspect -->
            <div class="data-image">
                <div id="data-image-loading"><div></div></div>
                <div class="image-wrapper">
                    <div id="diffviewer" class="viewer"></div>
                </div>
                <!-- image navigation -->
                <div class="image-nav">
                    <div class="pull-left">
                        <button class="btn btn-success btn-dk" onclick="changeBrightness('dk');">Dark</button>
                        <button class="btn btn-success btn-nm" onclick="changeBrightness('nm');">Normal</button>
                        <button class="btn btn-success btn-lt" onclick="changeBrightness('lt');">Light</button>
                    </div>
                    <div class="pull-left loaded-image overflow"><span><var id="framename"></var></span><br/>Osc: <var id="oscstart"></var> to <var id="oscend"></var></div>
                    <div class="pull-right">
                        <button class="btn btn-info" onclick="prevClicked();"><i class="fa fa-fw fa-chevron-left"></i></button>
                        <button class="btn btn-info" onclick="nextClicked();"><i class="fa fa-fw fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row col-xs-3 col-meta">
            <!-- Display of metaData -->
            <div class="meta-data">
                <p>Meta-Data
                   <span class="pull-right cursor"
                         title="Show/Hide"
                         data-target="#parameters" data-toggle="collapse">
                       <i class="fa fa-fw fa-expand"></i>
                   </span>
                </p>
                <div id="parameters" style="overflow: auto;" class="collapse">
                    <ul>
                        <li><strong>Beamline:</strong> {{ object.beamline }}</li>
                        <li><strong>Detector type:</strong> {{ object.detector }}</li>
                        {% if object.experiment %}
                        <li><strong>Experiment:</strong><a href="{% url "group-detail" object.experiment.pk %}">{{ object.experiment.name }}</a></li>
                        {% endif %}
                        {% if object.crystal %}
                        <li><strong>Crystal:</strong><a href="{% url "sample-detail" object.crystal.pk %}"> {{ object.crystal.name }}</a></li>
                        {% endif %}

                        {% for report in object.reports.all %}
                            <li><strong>Analysis Score: {{ report.score|color_score:2 }}</strong>  <a href="{% url "report-detail" report.pk %}">View Report</a></li>
                        {% endfor %}
                        <li><strong>Resolution Limit:</strong> {{ object.resolution|floatformat:2 }} &#8491;</li>
                        <li><strong>Wavelength:</strong> {{ object.wavelength }} &#8491;</li>
                        <li><strong>Beam X, Y:</strong>	{{ object.beam_x }}, {{ object.beam_y }}</li>
                        <li><strong>Pixel Size:</strong> {{ object.pixel_size }} mm</li>
                        <li><strong>Two Theta:</strong> {{ object.two_theta|floatformat:1}} deg</li>
                        <li><strong>Exposure time:</strong> {{ object.exposure_time }} sec</li>
                        <li><strong>Collection date:</strong> {{ object.modified }}</li>
                    </ul>
                </div>
            </div>

            <div class="frame-list">
                <p>{{ object.num_frames }} Frames</p>
                <ul>
                {% for frame_id in object.frames %}

                    <li><a onclick="toFrame({{ frame_id }});">{{object.name}}_{{ frame_id|stringformat:"04d" }}</a>&nbsp;
                        <a class="pull-right download-tool" href="{% get_image_url object frame_id %}" title="Download this image"><i class="fa fa-fw fa-download"></i></a>
                    </li>

                {% endfor %}
                </ul>
            </div>
            <div class="xtal-snapshot">
                <p>Sample Centering</p>
                <img id="xtal-pic"
                     src="{{ 'IMAGE_PREPEND'|get_from_settings }}/files/{{object.url}}/{{ object.name }}.gif"
                     title="Snapshots at {{object.start_angle}} and {{object.meta_data.start_angle|second_view}} deg" />
            </div>
        </div>
    </div>
<div>

{% endblock %}

{% block form_js %}
<script type="text/javascript">
function initModal() {
    var myform = $('#modalForm');
    myform.modal({backdrop: 'static'});
}
initModal();
</script>
{% endblock %}

{% block form_assets %}
<script src="{% static "jquery/jquery-migrate.min.js" %}"></script>
<script src="{% static "js/jquery.mousewheel-3.0.6.js" %}"></script>
<script type="text/javascript" src="/static/js/jquery.diffviewer.js"></script>
<script type="text/javascript">
    var dataViewer = function(){

        var  loadingTimer, loadingFrame= 1;
        var  loading = $('#data-image-loading');
        var  wavelength = 1.0;
        var  ref_resol = 2.0;
        var  theta_m = Math.asin(0.5*wavelength)/ref_resol;

        function  _animate_loading() {
            if (!loading.is(':visible')){
                clearInterval(loadingTimer);
                return;
            }
            jQuery('div', loading).css('top', (loadingFrame * -40) + 'px');
            loadingFrame = (loadingFrame + 1) % 12;
        }

        return {
            setPars: function(w, r) {
                wavelength = w;
                ref_resol = r;
                theta_m = Math.asin(0.5*wavelength)/ref_resol;
            },
            calcRes: function(f) {
                return (0.5*wavelength)/Math.sin(f * theta_m)
            },
            showActivity: function() {
                loading = jQuery('#data-image-loading');
                clearInterval(loadingTimer);
                loading.show();
                loadingTimer = setInterval(_animate_loading, 66);
            },
            hideActivity: function() {
                loading.hide();
            }
        }
    }();


	var $current_frame_to_display = {{object.first_frame}};
	var $current_brightness_to_display = 'nm';
	var $expanded_frame_set = {{ object.frames }};
    dataViewer.setPars({{object.wavelength}}, {{object.resolution}});

    $('[data-target="#parameters"]').click(function(e){
        e.preventDefault();
        e.stopPropagation();
        var target = $($(this).attr('data-target'));
        var frame_list = $('.frame-list ul');
        var height = 0;
        if (target.hasClass('in')) {
            height = frame_list.height() + $('#parameters').height();
        }
        $(this).find('i').toggleClass('fa-compress');
        target.toggleClass('in');

        if (!(height > 0)) {
            height = frame_list.height() - $('#parameters').height();
        }
        frame_list.height(height);
    });

	function changeBrightness(brightness) {
		if (brightness == $current_brightness_to_display) {
			return;
		}
		$('.active-brightness').removeClass('active-brightness');
		$('.btn-'+brightness).addClass('active-brightness');
		$current_brightness_to_display = brightness;
        updateFrame();
		//$("#diffviewer").diffviewer('loadImage', makeCorrectUrl());
	};

	function updateFrame() {
		url = '{% get_image_url object 0 %}';
		url = url.replace(/0000/i, zerofill($current_frame_to_display, 4));
		var src;
        $.ajax({
            url: '{% url "fetch-image" %}',
            data: {
                'url': url,
                'brightness': $current_brightness_to_display
            },
            success: function (response) {
                if (response['src']) {
                    src = response['src']
                } else {
                    src = "/static/img/image-not-found.png";
                }
                $("#diffviewer").diffviewer('loadImage', src);
                updateFrameDetails();
                }
        });
	}

	function zerofill(number, size) {
        return (number.toString().length >= size) ? number.toString() : ('0'.repeat(size) + number).slice(-size);
    }

	function generateFrameName(frame) {
		return "{{ object.name }}" + "_" + zerofill(frame, 4);
	}
	
	$(document).ready( function() {
		$current_frame_to_display = {{ object.first_frame }};
		$current_brightness_to_display = "nm";
		updateFrameDetails();
		var img_src = "{% get_image object object.first_frame 'nm' %}";
		if (!img_src) {
            img_src = "/static/img/image-not-found.png";
        }
		$expanded_frame_set = {{ object.frames }};
        $("#diffviewer").diffviewer({
            src: img_src,
            //update_on_resize: false,
            zoom: 50,
            zoom_min: 50,
            onStartLoad: function() {
                dataViewer.showActivity();
            },
            onFinishLoad: function() {
                $("#diffviewer").diffviewer('setCoords', -500, -500);
                dataViewer.hideActivity();
            },
            resFunc: function(r) {
                return dataViewer.calcRes(r);
            }
        });
	});
	
	function updateFrameDetails() {
		// use jQuery to find and update the frame specific elements. 
		element = $('#framename');
		element.text(generateFrameName($current_frame_to_display));
        if (element.width() > parseInt($('.loaded-image').css('maxWidth'))) {
            $('.loaded-image').addClass('reverse-ellipsis');
        }

		osc = ($current_frame_to_display - {{object.first_frame}}) * {{object.meta_data.delta_angle}} + {{object.meta_data.start_angle}};
		$('#oscstart').text(osc + " deg");
		
		osc = osc + {{object.meta_data.delta_angle|floatformat:1}};
		$('#oscend').text(osc + " deg");
		
	}	
	
	function nextClicked() {
		// get next frame in set.
        index = $.inArray($current_frame_to_display, $expanded_frame_set);
		if ((index != -1) && (index < $expanded_frame_set.length -1)) {
			index++;
			$current_frame_to_display = $expanded_frame_set[index];
            updateFrame();
			//$("#diffviewer").diffviewer('loadImage', makeCorrectUrl());
			//updateFrameDetails();
		}
		return;
	}
	
	function prevClicked() {
		// get previous frame in set
		index = $.inArray($current_frame_to_display, $expanded_frame_set);
		if ((index != -1) && (index > 0)) {
			index--;
			$current_frame_to_display = $expanded_frame_set[index];
            updateFrame();
			//$("#diffviewer").diffviewer('loadImage', makeCorrectUrl());
			//updateFrameDetails();
		}
		return;
	}		
	
	function toFrame(frame) {
        index = $.inArray(frame, $expanded_frame_set);
		if (index != -1) {
			$current_frame_to_display = $expanded_frame_set[index];
			updateFrame();
            //$("#diffviewer").diffviewer('loadImage', makeCorrectUrl());
			//updateFrameDetails();
		}
		return;
	}

    function getArchive(url) {
        jQuery.jGrowl("The archive of your dataset is being downloaded and it may take a while to complete this download.  Thank you for your patience!", { life: 10000 });
        jQuery.fancybox.showActivity();
		window.location = url;
		jQuery.fancybox.hideActivity();
    }
        

</script>
{% endblock %}
