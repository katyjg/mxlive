{% extends "users/base.html" %}

{% load icons %}
{% load humanize %}
{% load converter %}
{% load static %}
{% load time_extras %}
{% load data_server %}

{% block page_heading %}
    <h4 class="text-condensed">
        <span class="text-muted">{% if user.is_superuser %}{{ object.project|upper }} | {% endif %}</span><strong>{{ object.name }}</strong>
    </h4>
    <span class="text-muted">
        Beamline Session started {{ object.created|naturalday }}
    </span>
{% endblock %}

{% block object_tools %}
    <a href="{% url "session-reports" object.pk %}" title="Go to Reports from this session">
        {% show_icon label='Reports' icon='ti ti-md ti-bar-chart-alt' badge=object.num_reports %}
    </a>
    <a href="{% url "session-data" object.pk %}" title="Go to Data from this session">
        {% show_icon label='Data' icon='ti ti-md ti-layout-grid3' badge=object.datasets.count %}
    </a>
    <a href="#!" data-link="{% url "session-history" object.pk %}">
        {% show_icon label='History' icon='ti ti-md ti-timer' %}
    </a>
    {% if user.is_superuser %}
        <a href="{% url "session-statistics" pk=object.pk %}">
            {% show_icon label='Statistics' icon='ti ti-md ti-bar-chart' %}
        </a>
    {% endif %}
    {% if object.datasets.count %}
        <div class="separator"></div>
        <a href="{% url 'files-proxy' section='archive' path=object.download_url %}">
            {% show_icon label='Download' icon='ti ti-md ti-download' %}
        </a>
    {% endif %}
{% endblock %}

{% block object_status %}
    <div class="status-bar">
        <div class="row">
            {% if object.is_active %}
                <div class="col">
                    <h3 class="m-0"><span class="badge badge-info">Active</span></h3>
                </div>
            {% endif %}
            <div class="col">
                <small class="text-muted text-condensed">Datasets:</small><br>
                {{ object.datasets.count }}
            </div>
            <div class="col">
                <small class="text-muted text-condensed">Reports:</small><br>
                {{ object.num_reports }}
            </div>
            <div class="col">
                <small class="text-muted text-condensed">Total Time:</small><br>
                {{ object.total_time|humanize_duration }}
            </div>
            <div class="col">
                <small class="text-muted text-condensed">Start:</small><br>
                {{ object.start|naturalday }}
            </div>
        </div>
    </div>
{% endblock %}

{% block full %}
    {% with object.groups.all as groups %}
    <div class="row">
        <div class="col-4 col-lg-3">
            <div class="card">
                <div class="card-header p-1 text-center text-wide text-muted"><small>GROUPS</small></div>
                {% if groups %}
                    <div class="list-group list-group-flush" role="tablist">
                    {% for group in groups %}
                        <a class="list-group-item list-group-item-action" role="tab" aria-controls="group{{ group.pk }}"
                           id="show-group{{ group.pk }}" data-toggle="list" href="#group-{{ group.pk }}" data-group="{{ group.pk }}">
                            {% include "users/entries/group-nav.html" with session=object %}
                        </a>
                    {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="col-8 col-lg-9">
            <div class="tab-content">
                {% for group in groups %}
                    <div class="tab-pane fade" id="group-{{ group.pk }}" role="tabpanel" aria-labelledby="show-group{{ group.pk }}">
                    {% include "users/entries/group-protocol.html" with session=object %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endwith %}
{% endblock %}

{% block extra_js %}
<script>
    var getUrlParameter = function getUrlParameter(sParam) {
        var sPageURL = window.location.search.substring(1),
            sURLVariables = sPageURL.split('&'),
            sParameterName,
            i;

        for (i = 0; i < sURLVariables.length; i++) {
            sParameterName = sURLVariables[i].split('=');

            if (sParameterName[0] === sParam) {
                return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
            }
        }
    };

    function download_all(urls) {
        $.get("", {'urls': urls}, null, 'attachment');
    }

    $('[data-toggle="list"]').on('click', function(e) {
        var id = $(this).data('group');
        window.history.pushState(null, null, '?q=' + id);
    });

    $(document).ready(function(){
        var selected = getUrlParameter('q');
        if (!(selected)) {
            selected = $('[data-group]').first().data('group');
        }
        $('#show-group'+ selected).tab('show');
    });

</script>
{% endblock %}