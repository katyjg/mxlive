{% load static %}

<h3>Loaded Containers</h3>
<hr />
<div class="list-group list-group-hover">
    {% for container in object.children.all %}
        <div class="list-group-item" id="container-{{ container.pk }}">
            <span class="box-tools box-tools-inline pull-left" style="min-width: 40px;">
                <span class="text-condensed text-large" style="padding-left: 0; padding-right: 0.25em;">{{ container.location }}</span>
            </span>
            <span class="box-tools pull-right">
                <a class="pull-right" onclick="unload({{ container.pk }});" title="Unload Container">
                    <i class="fa fa-2 fa-fw fa-minus-circle"></i>
                    <br><span class="tool-label">Unload</span>
                    <form method="post" id="{{ container.pk }}-unload" action="{% url "container-unload" container.pk %}">
                        {% csrf_token %}
                        <input name="parent" type="hidden" />
                        <input name="location" type="hidden" />
                    </form>
                </a>

                <a class="pull-right" data-url="{% url "container-load" container.pk %}" title="Move Container">
                    <i class="fa fa-2 fa-fw fa-exchange"></i>
                    <br><span class="tool-label">Move</span>
                </a>
            </span>
            <h4 class="list-group-item-heading overflow ellipsis"><a href="{% url "container-detail" pk=container.pk %}"><span class="text-muted">{{ container.project|upper }}</span> | <strong>{{ container.name }}</strong></a></h4>
            <p class="list-group-item-text overflow ellipsis">
                <span class="text-muted">{{ container.kind }} | </span><strong>{{ container.sample_set.count }}</strong> sample{{ container.sample_set.count|pluralize }}
            </p>
            {% if container.children.count %}
                <small class="text-muted">
                 <table class="table table-hover">
                     <tr><th>Location</th>
                         <th>Container</th>
                         <th class="text-center">Samples</th>
                         <th class="text-center">Move</th>
                         <th class="text-center">Unload</th></tr>
                    {% for child in container.children.all %}
                        <tr id="container-{{ child.pk }}">
                            <td>
                                <strong>{{ container.location }}{{ child.location }}</strong>
                            </td>
                            <td><a href="{% url "container-detail" pk=child.pk %}"><span class="text-muted">{{ child.project|upper }}</span> | <strong>{{ child.name }}</strong></a>
                            </td>
                            <td class="text-center"><strong>{{ child.sample_set.count }}</strong></td>
                            <td class="text-center">
                                <a data-url="{% url "container-load" child.pk %}" title="Move Container">
                                    <i class="fa fa-2 fa-fw fa-exchange"></i>
                                </a>
                            </td>
                            <td class="text-center">
                                <a class="cursor" onclick="unload({{ child.pk }});" title="Unload Container">
                                    <i class="fa fa-2 fa-fw fa-minus-circle"></i>
                                </a>
                                <form method="post" id="{{ child.pk }}-unload" action="{% url "container-unload" child.pk %}">
                                    {% csrf_token %}
                                    <input name="parent" type="hidden" />
                                    <input name="location" type="hidden" />
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                 </table></small>
            {% endif %}
        </div>
    {% endfor %}
</div>

<script src="{% static "jquery/jquery.form.min.js" %}"></script>
<script>
    {% for container in object.children.all %}
        $('#container-{{ container.pk }}').hover(
        function() {
            $('#envelope-{{ container.parent.pk }}-{{ container.pk }}-{{ container.location }}').addClass('active-envelope');
        },
        function() {
            $('.active-envelope').removeClass('active-envelope');
        });
        $('#envelope-{{ container.parent.pk }}-{{ container.pk }}-{{ container.location }}').hover(function() {
            $('#container-{{ container.pk }}').addClass('active-envelope');
            $('#envelope-{{ container.parent.pk }}-{{ container.pk }}-{{ container.location }}').addClass('active-envelope');
        },
        function() {
            $('.active-envelope').removeClass('active-envelope');
        });
        {% for child in container.children.all %}
            $('#envelope-{{ container.pk }}-{{ child.location }}').hover(function() {
                $('#container-{{ container.pk }}').addClass('active-envelope');
                $('#envelope-{{ container.pk }}-{{ child.location }}').addClass('active-envelope');
            },
            function() {
                $('.active-envelope').removeClass('active-envelope');
            });
        {% endfor %}

    {% endfor %}
    $('[accepts]').click(function() {
        var location = $(this).attr('id').split('-')[$(this).attr('id').split('-').length-1];
        var container = $(this).attr('id').split('-')[$(this).attr('id').split('-').length-2];
        $('#modal-form').load("/users/containers/"+container+'/location/'+location+'/');
    });

function unload(e) {
    e.preventDefault;
    $(this).html('<i class="fa fa-spinner fa-spin"></i>');
    var form = $('form#'+e+'-unload');
    var url = form.attr('action');
    form.ajaxSubmit({
        type: 'post',
        url: url,
        success: function () {
            window.location.reload();
        },
        data: ""
    });
}
</script>
