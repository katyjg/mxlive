{% extends "modal/form.html" %}

{% load static %}

{% block modal_assets %}
    {{ block.super }}
    <script src="{% static "js/mxlive-layouts.js" %}"></script>
{% endblock %}
{% block modal_styles %}modal-lg{% endblock %}
{% block modal_title %}<strong>{{ shipment }}</strong> | Sample Seat Selection{% endblock %}
{% block modal_body %}
    <div class="row sample-seater">
        <div class="col-9">
            <div class="row">
                {% for container in shipment.containers.all %}
                    <div class="col-4 seater {{ container.kind.name|slugify }} text-center"
                         id="seater-{{ container.pk }}">
                        <h5 class="m-0">
                            <a href="#!" class="badge badge-secondary text-condensed text-thin" title="Toggle All"
                               data-pk="{{ container.pk }}"><strong>{{ container.name }}</strong>
                            </a>
                        </h5>
                        <div id="seats-for-{{ container.pk }}"
                             data-layout-url="{% url 'fetch-layout' pk=container.pk %}"
                             data-pk="{{ container.pk }}"
                             class="seat-container">
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        <div class="col-3 group-chooser">
            <div class="card">
                <div class="card-header p-1 text-center text-wide text-muted"><small>GROUPS</small></div>
                <div class="list-group-flush">
                    {% for group in shipment.groups_by_priority %}
                        {% with num_samples=group.samples.count %}
                            <a href="#!" class="list-group-item group-selector py-1"
                               data-group="{{ group.pk }}"
                               data-name="{{ group.name }}"
                               data-selector="{{ forloop.counter }}">
                                <strong>{{ group.name }}</strong>
                            </a>
                        {% endwith %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <div class="form-action row">
        <div class="col-9 small">
            <div class="alert alert-info m-0" id="seater-instructions">
                <i class="ti ti-xl ti-info-alt float-left pr-2"></i>
                Click on a group to select it, then click the locations of the corresponding samples in each container.
                Click previously selected samples to remove them.
            </div>
        </div>
        <div class="col-3 my-auto text-right">
            <button id='save-seats' class="btn btn btn-primary" name="save" type="button">Save Samples</button>
        </div>

    </div>
{% endblock %}

{% block modal_scripts %}
    <script>
        function initializeModal() {
            $('.seat-container').each(function () {
                $(this).layoutContainer({
                    detailed: true,
                    labelled: true,
                    loadable: false,
                    prefix: 'sscnt'
                });
            });
            const colorScale = d3.scaleOrdinal(d3.schemeCategory10);
            d3.selectAll('.group-chooser [data-selector]')
                .style('color', '#fff')
                .style('background-color', function () {
                    return colorScale($(this).data('selector'));
                }).on('click', function () {
                let remove = (!$(this).hasClass('selected'));
                $('.group-selector.selected').removeClass('selected');
                $(this).toggleClass('selected', remove);
            });
            
            $(document).on('click', 'svg.sample', function () {
                let group = $('.group-selector.selected').data();
                if (group) {
                    if ($(this).hasClass('empty')) {
                        $(this).removeClass('empty')
                            .attr('data-group', group.group)
                            .find(' > .envelope')
                                .attr('fill', colorScale(group.selector));
                    } else {
                        $(this).addClass('empty')
                            .removeData('group');
                    }
                }
            });
            $('.seater .badge[data-pk]').hover(
                function () { //enter
                    let group = $('.group-selector.selected').data();
                    if (group) {
                        $(this).css('background-color', colorScale(group.selector));
                    }
                },
                function () { //exit
                    let group = $('.group-selector.selected').data();
                    if (group) {
                        $(this).css('background-color', '');
                    }
                }
            ).click(function () {
                let group = $('.group-selector.selected').data();
                if (group) {
                    let pins = $('#seats-for-' + $(this).data('pk') + ' svg.sample');
                    let to_add = pins.filter('.empty');
                    let to_del = pins.filter('[data-group='+group.group+']');
                    if (to_add.length > 0) {
                        to_add.removeClass('empty')
                            .attr('data-group', group.group)
                            .find('> .envelope').attr('fill', colorScale(group.selector));
                    } else {
                        to_del.removeData('group')
                            .addClass('empty');
                    }
                }
            });
            $('#save-seats').click(function(){
                let info = [];
                $('.seat-container').each(function(){
                    let cid = $(this).data('pk');
                    $(this).find('svg.sample[data-group]').each(function(){
                        info.push({
                            group: $(this).data('group'),
                            container: cid,
                            location: $(this).data('loc'),
                        })
                    })
                });
                console.log(info);
            });
        }

        $('#modal').on('shown.bs.modal', function () {
            initializeModal();
        });
    </script>
{% endblock %}
