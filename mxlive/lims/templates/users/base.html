{% load static %}
<!DOCTYPE html>
<html lang="en" class="{% block html_class %}{% endblock %}">
<head>
	<meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block page_title %}MxLIVE{% endblock %}</title>

    <link href="/static/img/logo.ico" rel="SHORTCUT ICON">
	<link href="/static/css/reset.css" rel="stylesheet"> <!-- CSS reset -->
    <link href="/static/css/fonts.css" rel="stylesheet">
    <link href="/static/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/fontawesome/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/font-awesome-animation.min.css">
    <link rel="stylesheet" href="/static/themify-icons/themify-icons.css">
    {% block site_css %}
	<link rel="stylesheet" href="/static/css/toastr.css" type="text/css" />
    <link rel="stylesheet" href="/static/css/animate.css" type="text/css" />
    <link rel="stylesheet" href="/static/css/mxlive.css" type="text/css"/>
    {% endblock %}
    {% block extra_css %}{% endblock %}
    <script src="/static/jquery/jquery.min.js"></script>
    <script src="/static/jquery/jquery-ui.min.js"></script>
    {% block pre_js %}{% endblock %}
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body class="{% block body_class %}{% endblock %}">
<div id="spinner">
    <i class="fa fa-spinner fa-spin"></i>
</div>
<div class="wrapper">
    {% block body %}

	  <!-- User Profile Menu -->
        {% include "users/navs.html" %}

    <main id="main-content" class="content">
        <div class="pad-wrapper">
            <div class="pagelet">
                <div class="pagelet-header">
                    {% block object_tools %}{% endblock %}
                    {% block page_heading %}{% endblock %}
                </div>
                {% block object_status %}{% endblock %}
                <div class="pagelet-body">
                    {% block full %}{% endblock %}
                </div>
            </div>
        </div>
    </main>

    <div id="modal-form"></div>
    <div id="page-spinner"></div>
	<div id="help-content" class="main-content removed"></div>
{% endblock %}
</div>
{% include "users/messages.html" %}
<!-- Bootstrap -->
<script src="/static/bootstrap/js/bootstrap.min.js"></script>
<script src='/static/jquery/jquery.nicescroll.min.js'></script>
{% block post_js %}{% endblock %}
{% block extra_js %}{% endblock %}
<script>
function serverHeartBeat() {
    $.ajax({
        url: '/misc/ping/',
        success: function(result) {
            console.log(result);
            $('#page-spinner').removeClass('spinner');
        },
        error: function(result) {
            $('#page-spinner').addClass('spinner');
            console.log(result);
        }
    });
}
$(document).ready(function(){
	// enable tooltips

	$("[title]").not("[data-toggle='popover']").tooltip({
    		container: 'body',
    		viewport: {selector: 'body', padding: 5}
    		//placement: 'auto'
    });


	// Enable popovers
	$("[data-toggle='popover']").popover({
			container: 'body'
	   	//placement: 'bottom'
	});

    // Handle data-url and data-href
    $(document).on('click', '[data-href]', function(){
        var sel = getSelection().toString();
        if(!sel) {
            window.document.location = $(this).data("href");
        }
    });
    $(document).on('click', '[data-url]', function(){
        var sel = getSelection().toString();
        if(!sel) {
            $('#modal-form').load($(this).data('url'));
        }
    });

	// Remove modal content after it is hidden
 	$(document).on('hidden.bs.modal', '.modal', function () {
 	    $(this).remove();
 	});

    $(".scrollbox").niceScroll({
        cursorborder: "1px solid transparent",
        cursorwidth: "9px",
        autohidemode: "leave",
        cursoropacitymax: 0.7
    });
    $(".scrollbox").scroll(function(){
        $(this).getNiceScroll().resize();
    });
    {% if request.user.is_authenticated %}
        //setInterval(serverHeartBeat, 3000);
    {% endif %}
});
</script>

<script>
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}


function setupDragNDrop() {

    $(".draggable").draggable({
                helper: function( event ) {
                    return $( "<div class='drag-helper label label-info'>"+jQuery(this).html()+"</div>" );
                },
                scroll: true,
                cursorAt: { bottom: 5, right: 5 },
                revert: "invalid",
                start: function(event, ui) {
                    console.log($('.drag-helper'));
                    /* when starting the drag, store it's parent element (drag source) */
                    /*if (getModel(jQuery(this)) == 'none') {
                        var $parent_dom_el = jQuery(this).parents('.parent-stop').first();
                        jQuery(this).data('parent_dom_el', $parent_dom_el);
                    }
                    else {
                        var $parent_dom_el = jQuery(this);
                        jQuery(this).data('parent_dom_el', $parent_dom_el);
                    }*/
                }
                });
    $(".droppable").droppable({
        drop: function(event, ui) {
            $('#spinner').addClass('loading');
            // when dropping, retreive it's parent element (drag source)
            var drop_destinations = ['shipment','container','experiment','crystal','runlist'];
            var destination = $(this);
            var target = ui.draggable;
            for (i=0; i<drop_destinations.length; i=i+1)
            {
                if (destination.hasClass(drop_destinations[i])) {
                    var destination_model = drop_destinations[i];
                }
            }
            var destination_pk = destination.attr('rel');
            var target_model = destination.attr('accept');
            var target_pk = target.attr('id');

            var csrftoken = getCookie('csrftoken');

            var base_url = window.location.origin;
            var end_url = base_url + '/ajax/' + destination_model + '/' + destination_pk + '/' + target_model + '/' + target_pk;
            jQuery.ajax({
                type: "POST",
                url: end_url,
                data: { csrfmiddlewaretoken: csrftoken, target: target_pk },
                dataType: "json",
                success: function() {
                    console.log('hello');
                    window.location.reload();
                },
                error: function() {
                    // error, just reload the widget
                    console.log('error');
                    window.location.reload();
                    //loadWidgets();
                },
                always: function() {
                    $('#spinner').removeClass('loading');
                }
            });

        }
    });
}
</script>

<script>
            function loadWidgets() {
            jQuery(".widget").each(function(i, widget) {
                //console.log("reloading widgets");
                var $widget = jQuery(widget);
                $widget.find("ul").load($widget.attr("data"), function() {
                });
            });
        }

            function getModel(object) {
        	// widget first, so we know if it's from the sidebar widget area
        	if (object.hasClass("widget-item")) { return 'widget-item'; }
        	if (object.hasClass('widget')) { return 'widget'; }
        	if (object.hasClass('crystal')) { return 'crystal'; }
        	if (object.hasClass('experiment')) { return 'experiment'; }
        	if (object.hasClass('container')) { return 'container'; }
        	if (object.hasClass('cocktail')) { return 'cocktail'; }
        	if (object.hasClass('crystalform')) { return 'crystalform'; }
        	if (object.hasClass('shipment')) { return 'shipment'; }
        	if (object.hasClass('dewar')) { return 'dewar'; }
        	if (object.hasClass('project')) { return 'project'; }
        	if (object.hasClass('runlist')) { return 'runlist'; }
        	return 'none';
        }

        function setupRunlist() {
            jQuery(".runlist-experiment").click(function() {
                var data = window.location.pathname + "container/basic/"+jQuery(this).attr('id')+"/";
                jQuery("#containers").attr("data",data);
                jQuery(".container-widget-title").html(jQuery(this).attr('exp'));
                loadWidgets();
            });
            jQuery(".runlist-project").click(function() {
                var data = window.location.pathname + "container/basic/"+jQuery(this).attr('id')+"/";
                jQuery("#containers").attr("data",data);
                jQuery(".container-widget-title").html(jQuery(this).attr('project'));
                loadWidgets();
            });
        }

        function setupDragAndDrop() {
            jQuery(".draggable-link-parent").draggable({
                //helper: 'clone',
                helper: function( event ) {
				            return $( "<div class='drag-helper'>"+jQuery(this).html()+"</div>" );
			            },
                cursorAt: { cursor: "crosshair", bottom: 5, right: 5 },
                revert: "invalid",
                start: function(event, ui){
                	/* when starting the drag, store it's parent element (drag source) */
                	if (getModel(jQuery(this)) == 'none') {
                		var $parent_dom_el = jQuery(this).parents('.parent-stop').first();
                		jQuery(this).data('parent_dom_el', $parent_dom_el);
                	}
                	else {
                		var $parent_dom_el = jQuery(this);
                		jQuery(this).data('parent_dom_el', $parent_dom_el);
                	}
                }
            });
            jQuery(".droppable").droppable({
                accept: function( jQuery_draggable ) {
                <!-- need to modify this to allow for multiple acceptable drop items -->
                <!-- field of is() with . doesn't seem to work. -->
                	<!-- split attr on space -->
                	accept_str = jQuery(this).attr("accept");
                	split_str = accept_str.split(" ");
                	for (count=0; count<split_str.length; count=count+1)
                	{
                		if (jQuery_draggable.hasClass(split_str[count])) {
                			return true;
                		}
                	}
                    return false;
                },
                drop: function( event, ui ) {
                    jQuery.fancybox.showActivity();
                	// when dropping, retreive it's parent element (drag source)
                	var destination = jQuery(this);
                    current_url = window.location.href
                    cont_loc = jQuery(this).attr('container_location');
                    auto_loc = jQuery(this).attr('automounter_location');
                    base_url = jQuery(this).attr('rel');
                	if (!destination.hasClass('parent-stop')) {
               			destination = jQuery(this).parents('.parent-stop').first();
               		}

                    // Location object is dragged to is jQuery(this)
                    var dragged_obj = ui.draggable;

                    if (getModel(dragged_obj) != 'container' || current_url.search("shipping/shipment") == -1) {
                        base_url = 0
                    }
                    //console.log(base_url);
                    // Object being dragged is ui.draggable
                    var source = ui.draggable.parents('.parent-stop').first();

                    // generate the action url
                    // something like src/src_id/dest/dest_id/obj/obj_id
                    // ajax call url if it has droppable attr
                    // url will map to correct handler (eg: src experiment, dest widget, obj crystal will remove crystal from experiment)
                    // looks like /experiment/1/Crys_widget/0/crystal/2 (crystal id 2 removed from experiment 1, widget checked to determine remove, 0 unused)

                    // call to that URL replaces all of this, add, remove, and replace code...
                    // makes the logic all in the url space, easy to adjsut behaviour of one operation
                    // will give a lot of endpoints to maintain / worry about.

                    var end_url = getModel(source);
                    if (base_url) {
                        end_url = base_url + getModel(source)
                    }
                    if ((getModel(source) == 'widget') || (getModel(source) == 'none'))
                    {
                    	end_url = end_url + '/0/';
                    }
                    else {
                    	end_url = end_url + '/' + source.attr('id') + '/';
                    }
                    end_url = end_url + getModel(dragged_obj);
                    if (getModel(dragged_obj) == 'widget' || getModel(dragged_obj) == 'none')
                    {
                    	end_url = end_url + '/0/';
                    }
                    else {
                    	end_url = end_url + '/' + dragged_obj.attr('id') + '/';
                    }
                    if (getModel(dragged_obj) == 'crystal' && current_url.search("shipping/container") != -1)
                    {
                        end_url = end_url + 'loc/' + cont_loc + '/';
                    }
                    if (getModel(dragged_obj) == 'container' && current_url.search("staff/runlist") != -1)
                    {
                        end_url = end_url + 'loc/' + auto_loc + '/';
                    }

                    // call out to Ajax to perform the operation
                    // if this is a staff page we need to add project
                    jQuery.ajax({
  		            	type: "POST",
                		url: end_url,
                		//data: { items: draggableId, parent: parent, container_location: container_location }, // I think all ignored
                		dataType: "script",
                		success: function() {
                            window.location.reload();
               		 	},
               		 	error: function() {
               		 		// error, just reload the widget
               		 		loadWidgets();
               		 	}
            		});

                    jQuery("tr.expander.loaded").each( function() {
                        jQuery(this).children("td").load(jQuery(this).prev().attr("rel"), function() {});
                    });
                },
                activeClass: "lims-droppable-active",
                hoverClass: "lims-droppable-hover",
                tolerance: "pointer"
            });
        }

        jQuery("#widget, #content").on("DOMSubtreeModified", function() { setupDragNDrop();});

        loadWidgets();
</script>

</body>
</html>
