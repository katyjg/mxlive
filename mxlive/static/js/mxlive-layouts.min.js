(function(a){a.fn.layoutContainer=function(b){let c=a(this),d=a.extend({detailed:c.data("detailed"),labelled:c.data("labelled"),loadable:c.data("loadable"),prefix:c.data("prefix")||"cnt",root_id:c.data("pk"),on_complete:function(){}},b),e=c.data("layout-url");a.ajax({dataType:"json",url:e,success:function(b){let e=c.width(),f=e*(b.height||1),g=d.prefix+"-"+b.id,h=d3.select(c[0]).selectAll("svg").data([b]),i=h.enter().append("svg").attr("viewBox","0 0 "+e+" "+f).attr("data-detailed",d.detailed).attr("data-labelled",d.labelled).attr("data-prefix",d.prefix).attr("data-id",a=>a.id).attr("data-loc",a=>a.loc).attr("data-final",a=>a.final).attr("id",g);h.exit().remove(),d.detailed&&b.id&&b.final&&i.append(b.envelope||"circle").attrs({cx:"50%",cy:"50%",r:"49%",x:"0%",y:"0%",width:"100%",height:"100%"}).attr("fill","none").attr("class","envelope").attr("stroke","black").style("pointer-events","visibleStroke"),a("#"+g).drawContainer(b,d),listLoaded("#loaded-projects","#loaded-containers",b,d),c.find("[title]").tooltip(),d.loadable&&a(document).on("click","[data-unload-url]",function(){unloadUpdateData(this,d)}),d.on_complete()}})}})(jQuery),function(a){a.fn.drawContainer=function(b,c){var d=Math.sqrt;let e=a(this),f=a.extend({detailed:e.data("detailed")||!1,labelled:e.data("labelled")||!1,loadable:e.data("loadable")||!1,prefix:e.data("prefix")||"cnt"},c),g=e.width()||e.data("width"),h=e.height()||e.data("height"),i=f.detailed,j=d(g**2+h**2)/(100*d(2)),k=d3.select(e[0]).selectAll("svg[data-parent='"+b.id+"']").data(b.children||[]);k.exit().remove();let l=k.enter().append("svg").attrs(function(a){var c=Math.cos,d=Math.sin;let e=100*(2*(a.radius*j/g)),i=e*(g/h),k=100*a.x,l=100*a.y,m="loc-"+b.loc+"-"+a.loc;"circle"===b.envelope&&(k=100*(.5*a.x*d(a.y))+50,l=100*(.5*a.x*c(a.y))+50),m+=a.final&&f.detailed?" outline":f.detailed&&a.sample||!f.detailed&&a.final?" occupied":a.id&&!a.final?" ignore":" empty",a.sample&&a.started&&(m+=" started"),m+=b.accepts?" cursor":" sample";let n={x:(k-.5*e).toFixed(3)+"%",y:(l-.5*i).toFixed(3)+"%",width:e.toFixed(3)+"%",height:i.toFixed(3)+"%",class:m,id:f.prefix+"-"+a.parent+"-"+a.loc,"data-width":(e*g/100).toFixed(3),"data-height":(i*h/100).toFixed(3),"data-accepts":a.accepts,"data-detailed":f.detailed,"data-labelled":f.labelled,"data-prefix":f.prefix,"data-id":a.id,"data-parent":b.id,"data-loc":a.loc,"data-group":a.batch,"data-final":a.final,"data-project":a.owner?a.owner.toLowerCase():"null"};return a.id?!(f.loadable&&a.sample)&&(n.title=b.final?a.name:a.owner+"|"+a.name):a.accepts&&(n.title=a.loc),n}).style("pointer-events","all").on("click",function(c){let d="";f.loadable&&(c.accepts||c.final)&&(d3.event.stopPropagation(),d=c.id?`/users/containers/${f.root_id}/${c.id}/load/`:`/users/containers/${f.root_id}/${b.id}/location/${c.loc}/`,a("#modal-target").asyncForm({url:d,complete:function(b){let c=a("#"+f.prefix+"-"+b.id);c.empty(),c.drawContainer(b,f),listLoaded("#loaded-projects","#loaded-containers",b,f)}}))});l.append(a=>document.createElementNS(d3.namespaces.svg,a.envelope||"circle")).attrs(function(){return{x:"0%",y:"0%",width:"100%",height:"100%",cx:"50%",cy:"50%",r:"49%",class:"envelope"}}),(!b.final||f.labelled)&&l.append("text").attr("x","50%").attr("y","50%").attr("font-size","75%").attr("fill","black").attr("text-anchor","middle").attr("opacity",a=>a.id?.7:.3).attr("dominant-baseline","middle").text(function(a){return a.loc}),l.each(function(b){(i||!b.final)&&a("#"+a(this).attr("id")).drawContainer(b,f)})}}(jQuery);function extractProjects(a,b){return jQuery.each(b.children,function(b,c){c.owner&&c.final&&(!(c.owner in a)&&(a[c.owner]=[]),a[c.owner].push({loc:c.loc,id:c.id,project:c.owner,type:c.type,port:c.port,name:c.name,parent:c.parent,url:c.url,samples:c.children.filter(function(a){return a.id}).length})),c.children&&extractProjects(a,c)}),a}function compileProjects(a){let b=extractProjects({},a),c={projects:[],containers:[]};return jQuery.each(b,function(a,b){c.projects.push({name:a,parent:b[0].parent,details:b}),c.containers=c.containers.concat(b)}),c.containers.sort(function(c,a){return c.loc<a.loc?-1:0}),c}var locTemplate=_.template("<div class=\"row  list-cnt-<%= id %>\" data-highlight=\"id\" data-reference=\"<%= id %>\">       <h6 class=\"col d-flex flex-row justify-content-between my-0\">           <div class=\"flex-grow-1 align-self-center py-0\">               <div class=\"loc-list row\">                   <strong class=\"col-2\"><%= port %></strong>                   <span class=\"col mr-2\"><a href=\"<%= url %>\"><%= name %></a>&nbsp;<small class=\"float-right badge badge-pill badge-primary detail\"><%= samples %></small></span>                   <span class=\"col text-center text-muted detail\"><%= project %></span>               </div>           </div>           <div class=\"tools-box\">               <a href=\"#!\" data-unload-url=\"/users/containers/<%= root_id %>/<%= id %>/unload/\" data-id=\"<%= id %>\"                   <div class=\"icon-stack\">                       <i class=\"ti ti-share\"></i>                   </div>               </a>           </div>       </h6>"),projTemplate=_.template("<div class=\"row\" data-highlight=\"project\" data-reference=\"<%= name.toLowerCase() %>\">       <h4 class=\"col-2 text-condensed text-center align-self-center\"><span class=\"badge badge-pill badge-primary py-1\"><%= details.length %></span></h4>       <div class=\"col d-flex flex-row justify-content-between\">           <div class=\"flex-grow-1\"><h5 class=\"m-0\"><%= name %></h5>               <div class=\"loc-list\"><% _.each(details, function(container, i){ %><small class=\"text-muted d-inline-block list-cnt-<%= container.id %>\"><%= container.port %></small><% }); %>               </div>           </div>           <div class=\"project-list-tools tools-box\">               <a data-toggle=\"collapse\" href=\"#prj-<%= name.toLowerCase() %>-list\">                    <div class=\"icon-stack\">                       <i class=\"ti ti-md ti-zoom-in\"></i>                   </div>               </a>               <a href=\"#!\" data-form-link=\"/users/containers/<%= root_id %>/<%= parent %>/unload/<%= name.toLowerCase() %>/\">                   <div class=\"icon-stack\">                       <i class=\"ti ti-md ti-share\"></i>                   </div>               </a>           </div>       </div></div><div class=\"collapse detail-container-list row\" id=\"prj-<%= name.toLowerCase() %>-list\"><div class=\"col ml-5 my-1 \">     <% _.each(details, function(container, i){ container.root_id = root_id; %><%= locTemplate(container) %><% }); %></div></div>");function listLoaded(a,b,c,e){let f=compileProjects(c),g=d3.select(a).selectAll(a+" > div").data(f.projects||[]);g.exit().remove(),g.enter().append("div").attr("class","list-group-item py-1").attr("id",a=>"proj-"+a.name.toLowerCase()).attr("data-reference",a=>a.name.toLowerCase()).attr("data-reference","project").html(function(a){return a.details.sort(function(c,a){return c.loc<a.loc?-1:0}),a.root_id=e.root_id,projTemplate(a)}),g.attr("id",a=>"proj-"+a.name.toLowerCase()).attr("data-reference",a=>a.name.toLowerCase()).attr("data-reference","project").html(function(a){return a.details.sort(function(c,a){return c.loc<a.loc?-1:0}),a.root_id=e.root_id,projTemplate(a)});let h=d3.select(b).selectAll(b+" > div").data(f.containers||[]);h.exit().remove(),h.enter().append("div").attr("class",a=>"list-group-item py-1 list-cnt-"+a.id).html(function(a){return a.root_id=e.root_id,locTemplate(a)}),h.html(function(a){return a.root_id=e.root_id,locTemplate(a)}),$(a+" [title], "+b+" [title]").tooltip()}function unloadUpdateData(a,b){let c=$(a);$.ajax({type:"post",dataType:"json",url:c.data("unload-url"),data:{},beforeSend:function(a){a.setRequestHeader("X-CSRFToken",$.cookie("csrftoken"))},success:function(a){let c=$("#"+b.prefix+"-"+a.id);c.empty(),c.drawContainer(a,b),listLoaded("#loaded-projects","#loaded-containers",a,b)},error:function(){c.shake()}})}$(document).ready(function(){$(document).on("mouseenter","[data-highlight]",function(){let a="svg[data-"+$(this).data("highlight")+"='"+$(this).data("reference")+"'] >:first-child";$(a).addClass("active-envelope")}),$(document).on("mouseleave","[data-highlight]",function(){$("svg > .active-envelope").removeClass("active-envelope")})});