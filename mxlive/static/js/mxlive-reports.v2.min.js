function getPrecision(b,a){return Math.abs(Math.floor(Math.log10(((b[b.length-1]-b[0])/(a||8)).toPrecision(1))||2))}function renderMarkdown(b){return(new showdown.Converter).makeHtml(b)}
var figureTypes="histogram lineplot barchart scatterplot pie gauge timeline columnchart".split(" "),ColorSchemes={Live4:["#8f9f9a","#c56052","#9f6dbf","#a0b552"],Live8:"#073B4C #06D6A0 #FFD166 #EF476F #118AB2 #7F7EFF #afc765 #78C5E7".split(" "),Live16:"#67aec1 #c45a81 #cdc339 #ae8e6b #6dc758 #a084b6 #667ccd #cd4f55 #805cd6 #cf622d #a69e4c #9b9795 #6db586 #c255b6 #073B4C #FFD166".split(" "),Dark2:d3.schemeDark2,Set1:d3.schemeSet1,Set2:d3.schemeSet2,Set3:d3.scheme,Tableau10:d3.schemeTableau10},styleTemplate=
_.template("<%= selector %> { <%= rules %> }"),contentTemplate=_.template('<div id="entry-<%= id %>" <% let style = entry.style || ""; %> class="section-entry <%= style %>" >   <% if ((entry.title) &! (entry.kind))  { %>       <h4><%= entry.title %></h4>   <% } %>   <% if (entry.description) { %>       <div class="description"><%= renderMarkdown(entry.description) %></div>   <% } %>   <% if ((entry.kind === "table") && (entry.data)) { %>       <%= tableTemplate({id: id, entry: entry}) %>   <% } else if (figureTypes.includes(entry.kind)) { %>       <figure id="figure-<%= entry.id || id %>" data-type="<%= entry.kind %>" data-chart=\'<%= JSON.stringify(entry) %>\' >       </figure>   <% }%>   <% if (entry.notes) { %>       <div class="notes"><%= renderMarkdown(entry.notes) %></div>   <% } %></div>'),
sectionTemplate=_.template('<section id="section-<%= id %>" <% let style = section.style || "col-12"; %>       class="<%= style %>">       <%  if (section.title)  {%>       <h3 class="section-title col-12"><%= section.title %></h3>       <% } %>       <%  if (section.description)  {%>       <div class="description"><%= renderMarkdown(section.description) %></div>       <% } %>     <% _.each(section.content, function(entry, j){ %><%= contentTemplate({id: id+"-"+j, entry: entry}) %><% }); %></section>'),
tableTemplate=_.template('<table id="table-<%= id %>" class="table table-sm table-hover"><% if (entry.title) { %>   <caption class="text-center"><%= entry.title %></caption><% } %><% if (entry.header.includes("row")) { %>   <thead><tr>       <% _.each(entry.data[0], function(cell, i){ %>       <th><%= cell %></th>       <% }); %>   </tr></thead><% } %><tbody><% _.each(entry.data, function(row, j){ %>   <% if ((!entry.header.includes("row")) || (j>0)) { %>       <tr>       <% _.each(row, function(cell, i){ %>           <% if (entry.header.includes("column") && (i==0)) { %>               <th><%= cell %></th>           <% } else { %>               <td><%= cell %></td>           <% } %>       <% }); %>       </tr>   <% } %><% }); %></tbody></table>'),
NUM_TICKS=10;
function drawXYChart(b,a,c,d){var g=[],e=[],l={};d=void 0===d?"spline":d;var n={interpolation:{}},f={x:{},y:{},y2:{}},k=[],p=a.data.x[1],q=a.data.x[a.data.x.length-1],h=d3.scaleLinear().domain([p,q]),r=h.ticks(NUM_TICKS),m=function(a){return a},t=function(a){return a},u=2;switch(a.data["x-scale"]){case "time":m=function(a){return Date.parse(a)};f.x=$.extend(f.x,{type:"timeseries",tick:{format:a.data["time-format"],culling:{max:13}}});break;case "pow":case "inv-square":r="pow"===a.data["x-scale"]?1:
-1;m=d3.scalePow().exponent(2*r).domain([p,q]);t=m.invert;h.domain([m(p),m(q)]);r=h.ticks(NUM_TICKS);u=getPrecision(r);f.x=$.extend(f.x,{tick:{values:r,multiline:!1,format:function(a){return t(a).toFixed(u)}}});break;case "log":m=d3.scaleLog().domain([p,q]);t=m.invert;h.domain([m(p),m(q)]);r=h.ticks(NUM_TICKS);u=getPrecision(r);f.x=$.extend(f.x,{tick:{values:r,multiline:!1,format:function(a){return t(a).toFixed(u)}}});break;case "identity":f.x=$.extend(f.x,{type:"index",tick:{multiline:!1}});break;
default:f.x=$.extend(f.x,{tick:{values:r,fit:!0,multiline:!1,format:function(a){return t(a).toFixed(u)}}})}a.data["x-limits"]&&(f.x=$.extend(f.x,{min:m(a.data["x-limits"][0]),max:m(a.data["x-limits"][1]),padding:0}));a.data["y1-limits"]&&(f.y=$.extend(f.y,{min:a.data["y1-limits"][0],max:a.data["y1-limits"][1],padding:0}));a.data["y2-limits"]&&(f.y2=$.extend(f.y2,{min:a.data["y2-limits"][0],max:a.data["y2-limits"][1],padding:0}));["cardinal","basis","step","step-before","step-after"].includes(a.data.interpolation)&&
(d="spline",n.interpolation.type=a.data.interpolation);$.each(a.data.x,function(a,b){0===a?k.push(b):k.push(m(b))});f.x.label=a.data["x-label"]||a.data.x[0];e.push(k);b.removeData("chart").removeAttr("data-chart");$.each(a.data.y1,function(b,h){e.push(h);l[h[0]]="y";g.push(h[0]);0===b&&(f.y.label=a.data["y1-label"]||h[0])});$.each(a.data.y2,function(b,h){e.push(h);l[h[0]]="y2";g.push(h[0]);f.y2.show=!0;0===b&&(f.y2.label=a.data["y2-label"]||h[0])});var v=d3.scaleOrdinal().domain(g).range(c.scheme);
$.each(g,function(a,b){b in c.colors||(c.colors[b]=v(b))});d=c3.generate({bindto:"#"+b.attr("id"),size:{width:c.width,height:c.height},data:{type:d,columns:e,colors:c.colors,axes:l,x:a.data.x[0]},spline:n,point:{show:15>a.data.x.length},axis:f,grid:{y:{show:!0}},onresize:function(){this.api.resize({width:b.width(),height:b.width()*c.height/c.width})}});a.data.annotations&&d.xgrids(a.data.annotations);b.data("c3-chart",d)}
function drawBarChart(b,a,c){var d=[],g=[],e=[],l=function(a,b){return a};b.removeData("chart");b.removeAttr("data-chart");$.each(a.data.data[0],function(b,c){b===a.data["color-by"]?e.push(b):b!==a.data["x-label"]&&d.push(b)});if(a.data["color-by"]){var n=a.data["color-by"];$.each(a.data.data,function(a,b){g.includes(b[n])||g.push(b[n])});l=function(b,d){return"object"===typeof d?c.colors[a.data.data[d.index][n]]:b}}var f=d3.scaleOrdinal().domain(g.concat(d)).range(c.scheme);$.each(d,function(a,b){b in
c.colors||(c.colors[b]=f(b))});l=c3.generate({bindto:"#"+b.attr("id"),size:{width:c.width,height:c.height},data:{type:"bar",json:a.data.data,hide:e,color:l,colors:c.colors,keys:{x:a.data["x-label"],value:d},groups:a.data.stack||[]},grid:{y:{show:!0}},axis:{x:{type:"category",label:a.data["x-label"]},rotated:c.horizontal||!1},legend:{hide:1===d.length},bar:{width:{ratio:.6}},onresize:function(){this.api.resize({width:b.width(),height:b.width()*c.height/c.width})}});b.data("c3-chart",l)}
function drawHistogram(b,a,c){var d=a["y-scale"];a=a.data.data;b.removeData("chart");b.removeAttr("data-chart");d=c3.generate({bindto:"#"+b.attr("id"),size:{width:c.width,height:c.height},data:{type:"bar",json:a,colors:{y:c.scheme[b.parent().index()]},keys:{x:"x",value:["y"]}},axis:{x:{tick:{fit:!1,count:10,format:function(a){return a.toFixed(1)}}},y:{type:d}},legend:{hide:!0},grid:{y:{show:!0}},bar:{width:{ratio:.5}},onresize:function(){this.api.resize({width:b.width(),height:b.width()*c.height/
c.width})}});b.data("c3-chart",d)}function drawPieChart(b,a,c){var d={},g=[],e={};b.removeData("chart");b.removeAttr("data-chart");$.each(a.data.data,function(a,b){d[b.label]=b.value;g.push(b.label);e[b.label]=c.scheme[a]});a=c3.generate({bindto:"#"+b.attr("id"),size:{width:c.width,height:c.height},data:{type:"pie",json:[d],colors:e,keys:{value:g}},onresize:function(){this.api.resize({width:b.width(),height:b.width()*c.height/c.width})}});b.data("c3-chart",a)}
function drawScatterChart(b,a,c){drawXYChart(b,a,c,"scatter")}function drawLineChart(b,a,c){drawXYChart(b,a,c,"line")}
function callout(b,a,c){if(!a)return b.style("display","none");b.attr("data-label")&&(a=a+" - "+b.attr("data-label"));b.attr("data-label");b.style("display",null).style("pointer-events","none").style("font","10px sans-serif");c=b.selectAll("path").data([null]).join("path").attr("fill","var(--warning)").attr("stroke","black");b=b.selectAll("text").data([null]).join("text").call(function(b){return b.selectAll("tspan").data((a+"").split(/\n/)).join("tspan").attr("x",0).attr("y",function(a,b){return 1.1*
b+"rem"}).style("font-weight",function(a,b){return b?null:"bold"}).text(function(a){return a})});var d=b.node().getBBox(),g=d.width,e=d.height;b.attr("transform","translate("+-g/2+","+(10-d.y)+")");c.attr("d","M"+(-g/2-10)+",5H-5l5,-5l5,5H"+(g/2+10)+"v"+(e+10)+"h-"+(g+20)+"z")}
function drawTimeline(b,a,c){var d=[],g=c.width-10-10,e=g/2;$.each(a.data,function(a,b){d.includes(b.type)||d.push(b.type)});d.sort();var l=d3.scaleOrdinal().domain(d).range(c.scheme),n=d3.timeline().size([g,150]).extent([a.start,a.end]).bandStart(function(a){return a.start}).bandEnd(function(a){return a.end}).padding(2)(a.data),f=d3.scaleLinear().domain([a.start,a.end]).range([0,g]);a=d3.axisBottom().scale(f).tickFormat(d3.timeFormat("%H:%M"));var k=d3.select("#"+b.attr("id")).append("svg").attr("viewBox",
"-10 -10 "+c.width+" 240").attr("class","w-100");k.selectAll("rect.event").data(n).enter().append("rect").attr("class","event").attr("x",function(a){return a.start}).attr("x",function(a){return a.start}).attr("y",function(a){return a.y}).attr("height",function(a){return a.dy}).attr("width",function(a){return a.end-a.start}).attr("data-label",function(a){return""+a.label}).attr("data-type",function(a){return a.type}).attr("shape-rendering","geometricPrecision").style("fill",function(a){return l(a.type)}).style("stroke",
function(a){return l(a.type)}).attr("pointer-events","all").on("mouseover",function(){q.attr("data-label",$(this).data("label"))}).on("mouseout",function(){q.attr("data-label",null)});k.append("g").call(a).attr("transform","translate(0, 160)");var p=0;c=k.append("g");n=c.selectAll(".legend").data(d).enter().append("g").attr("class","legend").attr("data-type",function(a,b){return a}).attr("transform",function(a,b){if(0===b)return p=a.length+80,"translate(0,0)";var c=p;p+=a.length+80;return"translate("+
c+", 0)"}).on("mouseover",function(){var a=$(this).data("type");k.selectAll('rect.event:not([data-type="'+a+'"])').style("opacity",.1)}).on("mouseout",function(){k.selectAll("rect").style("opacity",1)});n.append("rect").attr("x",0).attr("y",0).attr("width",10).attr("height",10).style("fill",function(a){return l(a)});n.append("text").attr("x",20).attr("y",10).text(function(a,b){return a}).style("text-anchor","start").style("font-size","10");c.attr("transform","translate("+(e-p/2)+", 200)");var q=k.append("g");
k.append("g").attr("class","mouse-cursor").append("path").attr("class","mouse-line").style("stroke","var(--warning)").style("stroke-width","1px").style("opacity","0").attr("pointer-events","none");k.on("mouseleave",function(){d3.select(".mouse-line").style("opacity",0);q.call(callout,null)}).on("touchmove mousemove",function(){var a=d3.mouse(this),b=d3.timeFormat("%a %H:%M")(f.invert(a[0]));165>a[1]?(d3.select(".mouse-line").style("opacity",1).attr("d",function(){return"M "+a[0]+", 160, "+a[0]+" 0"}),
q.attr("transform","translate("+a[0]+", 164)").call(callout,b)):(d3.select(".mouse-line").style("opacity",0),q.call(callout,null))});b.removeData("chart").removeAttr("data-chart");window.onresize=function(){var a=g/b.width();k.selectAll("text").attr("transform","scale("+a+" "+a+")");k.selectAll("line").attr("stroke-width",a+"px")}}
(function(b){b.fn.liveReport=function(a){var c=b(this);a=b.extend({data:{}},a);c.addClass("report-viewer");b.each(a.data.details,function(a,b){c.append(sectionTemplate({id:a,section:b}))});c.find("figure").each(function(){var a=b(this),c=a.data("chart"),e={width:a.width(),height:a.width()/(c.data["aspect-ratio"]||16/9),colors:{}};Array.isArray(c.data.colors)?e.scheme=c.data.colors:"object"===typeof c.data.colors?(e.scheme=ColorSchemes.Live16,e.colors=c.data.colors):e.scheme=ColorSchemes[c.data.colors]||
ColorSchemes.Live16;switch(a.data("type")){case "barchart":e.horizontal=!0;drawBarChart(a,c,e);break;case "columnchart":drawBarChart(a,c,e);break;case "lineplot":drawLineChart(a,c,e);break;case "histogram":drawHistogram(a,c,e);break;case "pie":drawPieChart(a,c,e);break;case "scatterplot":drawScatterChart(a,c,e);break;case "timeline":drawTimeline(a,c,e)}c.title?a.after('<figcaption class="text-center">'+c.title+"</figcaption>"):a.after('<figcaption class="text-center"></figcaption>')})}})(jQuery);
