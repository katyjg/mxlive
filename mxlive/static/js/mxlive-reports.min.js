function rounded(a){var b=Math.pow(10,-Math.ceil(Math.log(Math.abs(a),10)));return Math.round(a*b)/b}function choose(a){var b=Math.floor(Math.random()*a.length);return a[b]}Array.cleanspace=function(c,d,e){var f=Math.ceil,g=[];e=e||7;var h=rounded((d-c)/8);c=f(c/h)*h,d=Math.floor(d/h)*h;var j=f((d-c)/e/h)*h;for(g[0]=c;c+j<=d;)g[g.length]=c+=j;return g};function inv_sqrt(b){for(var a=[],c=0;c<b.length;c++)a[c]=Math.pow(b[c],-.5);return a}function draw_pie_chart(){var b=Math.max;function a(a){a.each(function(a){var f=Math.cos,g=Math.min;function c(a){var b=Math.PI;return a*b/180}var h={out:10,left:b(10,.5*(width-height)),top:b(10,.5*(height-width))},j=d3.select(this).attr("viewBox","0 0 "+width+" "+height).append("g").attr("transform","translate("+h.left+","+h.top+")"),l=g(width-2*h.left,height-2*h.top)/2,m=d3.arc().innerRadius(l*innerRadius).outerRadius(l).startAngle(function(b,d){return c(a[d].start)}).endAngle(function(b,d){return c(a[d].start+a[d].value)}),n=function(){return"translate("+l+","+l+")"}(),o=j.append("g").attr("class","arc").attr("transform",n);o.selectAll("path").data(a).enter().append("path").attr("fill",function(b,c){return a[c].color||e(c)}).attr("d",m);var p=j.append("g").attr("class","axis-label").attr("transform",n),q=[];$.each(a,function(a,b){b.label&&q.push(b.label)}),1<q.length?p.selectAll("text").data(a).enter().append("text").attr("transform",function(b,d){var e=Math.sin,g=l+h.out,j=c(a[d].value/2+a[d].start-90),m=g*f(j),n=g*e(j);return"translate("+m+","+n+")"}).text(function(b,c){return a[c].label}).style("text-anchor",function(b,d){var e=l+h.out,g=c(a[d].value/2+a[d].start-90),j=e*f(g);return 0<j?"start":"end"}).attr("fill",function(b,c){return a[c].color||e(c)}):p.append("text").text(q[0]).attr("class","text-large").attr("text-anchor","middle").attr("alignment-baseline","middle")})}let c=d3.schemeSet2.concat(d3.schemeDark2),e=d3.scaleOrdinal(c);return a.width=function(b){return arguments.length?(width=b,a):width},a.height=function(b){return arguments.length?(height=b,a):height},a.innerRadius=function(b){return arguments.length?(innerRadius=b,a):innerRadius},a}function drawStackChart(a,b,c,e,f,g,h){function j(a,b=500,c=100){for(class_keep=a.id.split("id").pop(),idx=o.indexOf(class_keep),$.each(m.selectAll("rect"),function(a,d){$.each(d,function(a,d){d[idx]&&d3.select(d[idx]).transition().ease(d3.easeBounce).duration(b).delay(c).attr("y",y_orig[a]).attr("height",h_orig[a])})}),i=0;i<o.length;i++)o[i]!=class_keep&&m.selectAll(".class"+o[i]).transition().duration(b).delay(c).style("display","block")}function l(b){let c=b.id.split("id").pop(),d=o.indexOf(c),e=c;$.each(a[0],function(a){if(a.replace(/\s/g,"")===c)return e=a,!1});let f=d3.scaleLinear().range([h,0]).domain([0,d3.max(a,function(a){return a[e]})]);for(i=0;i<o.length;i++)o[i]!==c&&m.selectAll(".class"+o[i]).transition().duration(500).style("display","none");let l=[],n=[];$.each(m.selectAll("rect"),function(a,b){$.each(b,function(a,b){b[d]&&(h_keep=d3.select(b[d]).attr("height"),y_keep=d3.select(b[d]).attr("y"),l.push(y_keep),n.push(h_keep),h_base=d3.select(b[0]).attr("height"),y_base=d3.select(b[0]).attr("y"),h_shift=h_keep-h_base,y_new=y_base-h_shift,d3.select(b[d]).transition().ease(d3.easeBounce).duration(500).delay(100).attr("y",function(a){return h-(f(a.y0)-f(a.y1))}).attr("height",function(a){return f(a.y0)-f(a.y1)}).call(g))})})}e.domain(d3.keys(a[0]).filter(function(a){return a!==b&&"color"!==a})),a.forEach(function(a){var c=0;a.ages=e.domain().map(function(d){return{name:d,y0:c,y1:c+=+a[d],color:a.color||null,label:a[b]}}),a.total=a.ages[a.ages.length-1].y1}),f.domain(a.map(function(a){return a[b]})),g.domain([0,d3.max(a,function(a){return a.total})]),c.append("g").attr("class","x axis").attr("transform","translate(0,"+h+")").call(d3.axisBottom(f)).selectAll("text").attr("y",10).attr("x",0).attr("dy",".35em").style("text-anchor","middle");var m=c.selectAll("."+b+"").data(a).enter().append("g").attr("class","g").attr("transform",function(a){return"translate("+f(a[b])+",0)"}),n="0",o=[],p=c.selectAll(".legend").data(e.domain().slice().reverse()).enter().append("g").attr("class",function(a){return o.push(a.replace(/\s/g,"")),"legend"}).attr("transform",function(a,b){return"translate(0,"+20*b+")"});o=o.reverse(),m.selectAll("rect").data(function(a){return a.ages}).enter().append("rect").attr("width",f.bandwidth()).attr("class",function(a,b){return"class"+o[b]}).attr("title",function(a,b){return o[b]+" ("+a.label+"): "+(a.y1-a.y0)}).attr("y",function(a){return g(a.y1)}).attr("height",function(a){return g(a.y0)-g(a.y1)}).style("fill",function(a){return a.color&&a.color||e(a.name)}).style("opacity",function(a,b){return a.color&&1-.75/o.length*b||1}),1<o.length&&(p.append("circle").attr("cy",9).attr("r",9).style("fill",e).attr("id",function(a){return"id"+a.replace(/\s/g,"")}).on("mouseover",function(){"0"===n?d3.select(this).style("cursor","pointer"):n.split("class").pop()===this.id.split("id").pop()?d3.select(this).style("cursor","pointer"):d3.select(this).style("cursor","auto")}).on("click",function(){var a="#id"+n;d3.select(a).style("stroke","none"),n===this.id.split("id").pop()?(j($(a)[0],duration=500,delay=100),n="0"):("0"!==n&&j($(a)[0],duration=0,delay=0),d3.select(this).style("stroke","black").style("stroke-width",2),n=this.id.split("id").pop(),l(this))}),p.append("text").attr("x",24).attr("y",9).attr("dy",".35em").style("text-anchor","start").text(function(a){return a}))}function draw_xy_chart(){var b=Math.max,c=Math.pow,d=Math.abs;function a(a){a.each(function(a){var e=[];notes.length&&$.each(notes,function(a,b){b.label&&e.push(b.label)});var f=e.length&&40||0,g=20;xlabel&&(g=50);var h={top:20,right:.15*width,bottom:g,left:.15*width},j=width-h.left-h.right,l=height-h.top-h.bottom,m=d3.select(this).attr("viewBox","0 0 "+width+" "+height).append("g").attr("transform","translate("+h.left+","+h.top+")"),o=d3.scaleOrdinal(d3.schemeDark2),q=[],r=[],s=[],t=[];if("bar"===scatter){var u=a.color,v=xlimits[0]||d3.min(a.data),w=xlimits[1]||d3.max(a.data);switch(xscale){case"time":var x=d3.scaleTime().range([0,j]).domain([v,w]);break;case"linear":var x=d3.scaleLinear().range([0,j]).domain([v,w]);}var y=d3.histogram().value(function(a){return a}).domain([d3.min(a.data),d3.max(a.data)]).thresholds(x.ticks(binning))(a.data),z=d3.scaleLinear().domain([0,d3.max(y,function(a){return a.length})]).range([l,0])}else{var v=xlimits[0]||d3.min(a,function(a){return d3.min(a.x)}),w=xlimits[1]||d3.max(a,function(a){return d3.max(a.x)});switch(xscale){case"inv-square":var x=d3.scalePow().exponent(-2).range([0,j]).domain([w,v]);break;case"pow":var x=d3.scalePow().range([0,j]).domain([v,w]);break;case"log":var x=d3.scaleLog().range([0,j]).domain([v,w]);break;case"identity":var x=d3.scaleIdentity().range([0,j]).domain([v,w]);break;case"time":var x=d3.scaleTime().range([0,j]).domain([v,w]);break;case"linear":var x=d3.scaleLinear().range([0,j]).domain([v,w]);break;case"inverse":var x=d3.scaleLinear().range([0,j]).domain([w,v]);}switch(interpolation){case"cardinal":var A=d3.curveCardinal;break;case"step":var A=d3.curveStep;break;case"step-after":var A=d3.curveStepAfter;break;case"step-before":var A=d3.curveStepBefore;break;case"basis":var A=d3.curveBasis;break;case"linear":var A=d3.curveLinear;}for(var B=0;B<a.length;B++)a[B].color=o(B),a[B].y1&&(q=q.concat(a[B].y1),s.push(a[B])),a[B].y2&&(r=r.concat(a[B].y2),t.push(a[B]));var z=d3.scaleLinear().range([l-f,0]).domain([y1limits[0]||d3.min(q),y1limits[1]||d3.max(q)]),n=d3.scaleLinear().range([l-f,0]).domain([y2limits[0]||d3.min(r),y2limits[1]||d3.max(r)])}var C=d3.axisBottom().scale(x).tickSize(-l);if("inv-square"===xscale){var D=inv_sqrt(Array.cleanspace(c(w,-2),c(v,-2),8));C.tickValues(D).tickFormat(d3.format(".3"))}else"time"===xscale&&timeformat&&C.ticks(7).tickFormat(d3.timeFormat(timeformat));var E=d3.axisLeft().scale(z).tickSize(-j),F=d3.axisRight().scale(n);if(m.append("g").attr("class","x axis").attr("transform","translate(0,"+l+")").call(C),m.append("text").attr("transform","translate("+j/2+","+(height-h.bottom/2)+")").style("text-anchor","middle").text(xlabel),m.append("g").attr("class","y axis").call(E).append("text").attr("transform","translate(0,"+l/2+"), rotate(-90)").attr("y",6).attr("dy","-3.5em").style("text-anchor","middle").attr("fill",function(){return 1<s.length||!s.length?"#000000":s.length&&s[0].color}).text(y1label),"bar"===scatter){var G=m.selectAll(".bar").data(y).enter().append("g").attr("class","bar").attr("fill",u).attr("transform",function(a){return"translate("+x(a.x0)+","+z(a.length)+")"});G.append("rect").attr("x",1).attr("title",function(a){return"time"===xscale&&timeformat?d3.timeFormat(timeformat)(a.x0)+"-"+d3.timeFormat(timeformat)(a.x1)+": "+a.length+"entries":a.x0+"-"+a.x1+": "+a.length+" entries"}).attr("width",x(y[0].x1)-b(0,x(y[0].x0)-1)).attr("height",function(a){return l-z(a.length)})}else{for(var H=[],I=[],B=0;B<a.length;B++)a[B].y1?H.push(d3.line().curve(A).x(function(a){return x(a[0])}).y(function(a){return z(a[1])})):a[B].y2&&I.push(d3.line().curve(A).x(function(a){return x(a[0])}).y(function(a){return n(a[1])}));r.length&&m.append("g").attr("class","y axis").attr("transform","translate("+j+", 0)").call(F).append("text").attr("transform","translate(0,"+l/2+"), rotate(-90)").attr("y",55).attr("dy",0).style("text-anchor","middle").attr("fill",function(){return 1<t.length?"#000000":t[0].color}).text(y2label);for(var J=m.selectAll(".d3_xy1_chart_line").data(s.map(function(a){return d3.zip(a.x,a.y1)})).enter().append("g").attr("class","d3_xy1_chart_line"),K=m.selectAll(".d3_xy2_chart_line").data(t.map(function(a){return d3.zip(a.x,a.y2)})).enter().append("g").attr("class","d3_xy2_chart_line"),B=0;B<H.length;B++)if("line"===scatter)J.append("path").attr("class","line").attr("d",function(a){return H[B](a)}).attr("data-legend",function(a,b){return s[b].label||null}).attr("stroke",function(a,b){return s[b].color}).attr("fill","none");else for(k=0;k<s.length;k++)var L=s[k].x.map(function(a,b){return[a,s[k].y1[b]]}),M=m.selectAll("dot").data(L).enter().append("circle").attr("r",2).attr("cx",function(a){return x(a[0])}).attr("cy",function(a){return z(a[1])}).attr("fill",function(){return s[k].color});for(var B=0;B<I.length;B++)if("line"===scatter)K.append("path").attr("class","line").attr("d",function(a){return I[B](a)}).attr("data-legend",function(a,b){return t[b].label||null}).attr("stroke",function(a,b){return t[b].color}).attr("fill","none");else for(k=0;k<t.length;k++)var L=t[k].x.map(function(a,b){return[a,t[k].y2[b]]}),M=m.selectAll("dot").data(L).enter().append("circle").attr("r",2).attr("cx",function(a){return x(a[0])}).attr("cy",function(a){return n(a[1])}).attr("fill",function(){return t[k].color});legend=m.append("g").attr("class","legend").attr("transform","translate(50,30)").call(d3.legend);var N=m.append("g").attr("class","mouse-over-effects");N.append("path").attr("class","mouse-line").style("stroke","#333").style("stroke-width","0.5px").style("opacity","0");$(this).find(".line");if(t){for(var O=[],B=0;B<s.length;B++)O.push({x:s[B].x,y1:s[B].y1});for(var B=0;B<t.length;B++)O.push({x:t[B].x,y1:t[B].y2,scale:n});var P=N.selectAll(".mouse-per-line").data(O).enter().append("g").attr("class","mouse-per-line")}else var P=N.selectAll(".mouse-per-line").data(a).enter().append("g").attr("class","mouse-per-line");P.append("circle").attr("r",2).style("fill","none").style("stroke-width","4px").style("opacity","0"),P.append("text").attr("transform","translate(10,3)");var Q=m.append("text").attr("transform","translate("+(j-3)+", "+(l-3)+")").style("text-anchor","end").style("opacity","0");N.append("rect").attr("width",j).attr("height",l).attr("fill","none").attr("pointer-events","all").on("mouseout",function(){m.select(".mouse-line").style("opacity","0"),m.selectAll(".mouse-per-line circle").style("opacity","0"),m.selectAll(".mouse-per-line text").style("opacity","0"),Q.style("opacity","1")}).on("mouseover",function(){m.select(".mouse-line").style("opacity","1"),m.selectAll(".mouse-per-line circle").style("opacity","1"),m.selectAll(".mouse-per-line text").style("opacity","1"),Q.style("opacity","1")}).on("mousemove",function(){var a=d3.mouse(this);m.select(".mouse-line").attr("d",function(){var b="M"+a[0]+","+l;return b+=" "+a[0]+","+0,b}),m.selectAll(".mouse-per-line").style("stroke",function(a,b){return o(b)}).attr("transform",function(b){var c=x.invert(a[0]);"time"===xscale?Q.text("X = "+d3.timeFormat(timeformat)(c)):Q.text("X = "+c.toFixed(2));var e=b.x.reduce(function(a,b){return d(b-c)<d(a-c)?b:a}),f=b.x.indexOf(e),g=b.scale||z,h=g(b.y1[f]);return d3.select(this).select("text").style("stroke","none").text(g.invert(h).toFixed(2)),"translate("+x(e)+","+h+")"})})}for(i=0;i<notes.length;i++){var R=notes[i].xstart&&x(notes[i].xstart)||notes[i].x&&x(notes[i].x)||0,S=notes[i].xend&&x(notes[i].xend)||notes[i].x&&x(notes[i].x)||0,T=notes[i].ystart&&z(notes[i].ystart)||0,U=notes[i].yend&&z(notes[i].yend)||l-f;m.append("path").attr("class",notes[i].label+" "+(notes[i]["class"]||"")+" "+(null!==notes[i].display&&(!0===notes[i].display&&"visible "||"hidden"))||"visible").style("stroke",notes[i].color||"#333").attr("d",function(){var a="M"+R+","+U;return a+=" "+S+","+T,a}),m.append("text").attr("class",notes[i].label+" "+(notes[i]["class"]||"")+" "+(null!==notes[i].display&&(!0===notes[i].display&&"visible "||"hidden"))||"visible").text(notes[i].label).style("fill",notes[i].color||"#333").attr("transform","translate("+(R+3)+","+(z(0)+f/2)+"), rotate(-90)").style("text-anchor","middle")}})}return a.width=function(b){return arguments.length?(width=b,a):width},a.height=function(b){return arguments.length?(height=b,a):height},a.xlabel=function(b){return arguments.length?(xlabel=b,a):xlabel||""},a.y1label=function(b){return arguments.length?(y1label=b,a):y1label},a.y2label=function(b){return arguments.length?(y2label=b,a):y2label},a.xscale=function(b){return arguments.length?(xscale=b,a):xscale},a.scatter=function(b){return arguments.length?(scatter=b,a):scatter},a.notes=function(b){return arguments.length?(notes=b,a):notes||[]},a.interpolation=function(b){return arguments.length?(interpolation=b,a):interpolation},a.xlimits=function(b){return arguments.length?(xlimits=b,a):xlimits||[null,null]},a.y1limits=function(b){return arguments.length?(y1limits=b,a):y1limits||[null,null]},a.y2limits=function(b){return arguments.length?(y2limits=b,a):y2limits||[null,null]},a.binning=function(b){return arguments.length?(binning=b,a):binning},a.timeformat=function(b){return arguments.length?(timeformat=b,a):timeformat},a}function build_report(a,b){$(a).addClass("report-viewer");var c=new showdown.Converter,d=d3.schemeSet2.concat(d3.schemeDark2);$.each(b.details,function(b,e){var f=$(a).append("<section id=\"section-"+b+"\"></section>").children(":last-child");e.title&&f.append("<h3 class='col-12 section-title' >"+e.title+"</h3>"),f.addClass(e.style||"col-12"),e.description&&f.append("<div class='col-12'>"+c.makeHtml(e.description)+"</div>"),$.each(e.content,function(a,e){var g=f.append("<div id='entry-"+b+"-"+a+"'></div>").children(":last-child");if(g.addClass(e.style||""),e.title&&!e.kind&&g.append("<h4>"+e.title+"</h4>"),e.description&&g.append("<div class='description'>"+c.makeHtml(e.description)+"</div>"),"table"===e.kind){if(e.data){var h=$("<table id='table-"+b+"-"+a+"' class='table table-hover table-sm'></table>"),j=$("<thead></thead>"),m=$("<tbody></tbody>");$.each(e.data,function(a,b){if(b){var c=$("<tr></tr>");for(k=0;k<b.length;k++){if(0===k&&e.header.includes("column")||0===a&&e.header.includes("row"))var d=$("<th></th>").text(b[k]);else var d=$("<td></td>").text(b[k]);c.append(d)}e.header.includes("row")&&0===a?j.append(c):m.append(c)}}),e.title&&h.append("<caption class='text-center'>"+e.title+"</caption>"),h.append(j),h.append(m),g.append(h)}}else if("barchart"===e.kind){$("#entry-"+b+"-"+a).append("<figure id='figure-"+b+"-"+a+"'></figure>");var n=e.data.data,o={top:20,right:20,bottom:50,left:40},p=$("#figure-"+b+"-"+a).width()-o.left-o.right,q=9*p/16,r=d3.scaleBand().range([0,p]).padding(.1),l=d3.scaleLinear().range([q,0]),s=d3.scaleOrdinal(e.data.colors||d),t=d3.select("#figure-"+b+"-"+a).append("svg").attr("id","plot-"+b+"-"+a).attr("viewBox","0 0 "+(p+o.left+o.right)+" "+(q+o.top+o.bottom)).append("g").attr("transform","translate("+o.left+","+o.top+")");drawStackChart(n,e.data["x-label"],t,s,r,l,q),e.title&&$("#figure-"+b+"-"+a).append("<figcaption class='text-center'>Figure "+($("figure").length+1)+". "+e.title+"</figcaption>")}else if("lineplot"===e.kind||"scatterplot"===e.kind||"histogram"===e.kind){$("#entry-"+b+"-"+a).append("<figure id='figure-"+b+"-"+a+"'></figure>");var n=[],u=e.data["x-label"]||e.data.x&&e.data.x.shift()||null,v=e.data["x-scale"]||"linear",w=e.data["x-limits"]||[null,null],x=e.data["y1-limits"]||[null,null],y=e.data["y2-limits"]||[null,null],z=e.data.interpolation||"linear",A=e.data.annotations||[],B=e.data.bins||50,C=e.data["time-format"]||null,D="",E="";"histogram"===e.kind?(n={data:e.data.data,color:e.data.color||choose(d)},"time"==v&&$.each(n.data,function(a,b){n.data[a]=new Date(b)})):("time"==v&&$.each(e.data.x,function(a,b){e.data.x[a]=new Date(b)}),$.each(e.data.y1,function(a,b){D=b.shift(),n.push({label:D,x:e.data.x,y1:b})}),$.each(e.data.y2,function(a,b){E=b.shift(),n.push({label:E,x:e.data.x,y2:b})}));var p=$("#figure-"+b+"-"+a).width();D=e.data["y1-label"]||D,E=e.data["y2-label"]||E;var F=draw_xy_chart().width(p).height(9*p/16).xlabel(u).y1label(D).y2label(E).xlimits(w).y1limits(x).y2limits(y).xscale(v).notes(A).binning(B).timeformat(C).interpolation(z).scatter("scatterplot"===e.kind&&"scatter"||"lineplot"===e.kind&&"line"||"histogram"===e.kind&&"bar"),G=d3.select("#figure-"+b+"-"+a).append("svg").attr("viewBox","0 0 "+p+" "+9*p/16).attr("id","plot-"+b+"-"+a).datum(n).call(F);e.title&&$("#figure-"+b+"-"+a).append("<figcaption class='text-center'>"+e.title+"</figcaption>")}else if("pie"===e.kind||"gauge"===e.kind){$("#entry-"+b+"-"+a).append("<figure id='figure-"+b+"-"+a+"'></figure>");var n=[],p=g.width(),H=0;$.each(e.data,function(a,b){(e.data[a].start||H)!=H&&(n.push({start:H,value:e.data[a].start-H,color:"#ffffff"}),H+=e.data[a].start-H),b.start=b.start||H,n.push(b),H+=e.data[a].value});var I=draw_pie_chart().width(p).height(9*p/16).innerRadius("gauge"===e.kind&&.5||0),G=d3.select("#figure-"+b+"-"+a).append("svg").attr("viewBox","0 0 "+p+" "+9*p/16).attr("id","plot-"+b+"-"+a).attr("class","gauge").datum(n).call(I);e.title&&$("#figure-"+b+"-"+a).append("<figcaption class='text-center'>"+e.title+"</figcaption>")}e.notes&&g.append("<div class='notes'>"+c.makeHtml(e.notes)+"</div>")})})}(function(a){a.fn.liveReport=function(b){let c=a(this),d={data:{},scheme:d3.schemeSet2},e=a.extend(d,b);c.addClass("report-viewer"),build_report(this,e.data)}})(jQuery);