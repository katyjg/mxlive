function rounded(a){var b=Math.pow(10,-Math.ceil(Math.log(Math.abs(a),10)));return Math.round(a*b)/b}Array.cleanspace=function(c,d,e){var f=Math.ceil,g=[];e=e||7;var h=rounded((d-c)/8);c=f(c/h)*h,d=Math.floor(d/h)*h;var j=f((d-c)/e/h)*h;for(g[0]=c;c+j<=d;)g[g.length]=c+=j;return g};function inv_sqrt(b){for(var a=[],c=0;c<b.length;c++)a[c]=Math.pow(b[c],-.5);return a}function draw_pie_chart(){function a(a){a.each(function(a){var c=Math.cos;function b(a){var b=Math.PI;return a*b/180}var e={out:10,left:.1*width},f=d3.select(this).attr("width",width).attr("height",height).append("g").attr("transform","translate("+e.left+","+e.left+")"),g=width/2-e.left,h=d3.arc().innerRadius(g*innerRadius).outerRadius(g).startAngle(function(c,d){return b(a[d].start)}).endAngle(function(c,d){return b(a[d].start+a[d].value)}),j=function(){return"translate("+g+","+g+")"}(),l=f.append("g").attr("class","arc").attr("transform",j);l.selectAll("path").data(a).enter().append("path").attr("fill",function(b,c){return a[c].color}).attr("d",h);var m=f.append("g").attr("class","label").attr("transform",j),n=[];$.each(a,function(a,b){b.label&&n.push(b.label)}),1<n.length?m.selectAll("text").data(a).enter().append("text").attr("transform",function(f,d){var h=Math.sin,j=g+e.out,l=b(a[d].value/2+a[d].start-90),m=j*c(l),n=j*h(l);return"translate("+m+","+n+")"}).text(function(b,c){return a[c].label}).style("text-anchor",function(f,d){var h=g+e.out,j=b(a[d].value/2+a[d].start-90),l=h*c(j);return 0<l?"start":"end"}).attr("fill",function(b,c){return a[c].color}):m.append("text").text(n[0]).attr("class","text-large").attr("text-anchor","middle").attr("alignment-baseline","middle")})}return a.width=function(b){return arguments.length?(width=b,a):width},a.height=function(b){return arguments.length?(height=b,a):height},a.innerRadius=function(b){return arguments.length?(innerRadius=b,a):innerRadius},a}function drawStackChart(a,b,c,e,f,g,h){function j(a,b=500,c=100){for(class_keep=a.id.split("id").pop(),idx=o.indexOf(class_keep),$.each(m.selectAll("rect"),function(a,d){$.each(d,function(a,d){d[idx]&&d3.select(d[idx]).transition().ease(d3.easeBounce).duration(b).delay(c).attr("y",y_orig[a]).attr("height",h_orig[a])})}),i=0;i<o.length;i++)o[i]!=class_keep&&m.selectAll(".class"+o[i]).transition().duration(b).delay(c).style("display","block")}function l(b){let c=b.id.split("id").pop(),d=o.indexOf(c),e=c;$.each(a[0],function(a){if(a.replace(/\s/g,"")===c)return e=a,!1});let f=d3.scaleLinear().range([h,0]).domain([0,d3.max(a,function(a){return a[e]})]);for(i=0;i<o.length;i++)o[i]!==c&&m.selectAll(".class"+o[i]).transition().duration(500).style("display","none");let l=[],n=[];$.each(m.selectAll("rect"),function(a,b){$.each(b,function(a,b){b[d]&&(h_keep=d3.select(b[d]).attr("height"),y_keep=d3.select(b[d]).attr("y"),l.push(y_keep),n.push(h_keep),h_base=d3.select(b[0]).attr("height"),y_base=d3.select(b[0]).attr("y"),h_shift=h_keep-h_base,y_new=y_base-h_shift,d3.select(b[d]).transition().ease(d3.easeBounce).duration(500).delay(100).attr("y",function(a){return h-(f(a.y0)-f(a.y1))}).attr("height",function(a){return f(a.y0)-f(a.y1)}).call(g))})})}e.domain(d3.keys(a[0]).filter(function(a){return a!==b&&"color"!==a})),a.forEach(function(a){var c=0;a.ages=e.domain().map(function(d){return{name:d,y0:c,y1:c+=+a[d],color:a.color||null,label:a[b]}}),a.total=a.ages[a.ages.length-1].y1}),f.domain(a.map(function(a){return a[b]})),g.domain([0,d3.max(a,function(a){return a.total})]),c.append("g").attr("class","x axis").attr("transform","translate(0,"+h+")").call(d3.axisBottom(f)).selectAll("text").attr("y",10).attr("x",-10).attr("dy",".35em").attr("transform","rotate(-45)").style("text-anchor","end");var m=c.selectAll("."+b+"").data(a).enter().append("g").attr("class","g").attr("transform",function(a){return"translate("+f(a[b])+",0)"}),n="0",o=[],p=c.selectAll(".legend").data(e.domain().slice().reverse()).enter().append("g").attr("class",function(a){return o.push(a.replace(/\s/g,"")),"legend"}).attr("transform",function(a,b){return"translate(0,"+20*b+")"});o=o.reverse(),m.selectAll("rect").data(function(a){return a.ages}).enter().append("rect").attr("width",f.bandwidth()).attr("class",function(a,b){return"class"+o[b]}).attr("title",function(a,b){return o[b]+" ("+a.label+"): "+(a.y1-a.y0)}).attr("y",function(a){return g(a.y1)}).attr("height",function(a){return g(a.y0)-g(a.y1)}).style("fill",function(a){return a.color&&a.color||e(a.name)}).style("opacity",function(a,b){return a.color&&1-.75/o.length*b||1}),1<o.length&&(p.append("circle").attr("cy",9).attr("r",9).style("fill",e).attr("id",function(a){return"id"+a.replace(/\s/g,"")}).on("mouseover",function(){"0"===n?d3.select(this).style("cursor","pointer"):n.split("class").pop()===this.id.split("id").pop()?d3.select(this).style("cursor","pointer"):d3.select(this).style("cursor","auto")}).on("click",function(){var a="#id"+n;d3.select(a).style("stroke","none"),n===this.id.split("id").pop()?(j($(a)[0],duration=500,delay=100),n="0"):("0"!==n&&j($(a)[0],duration=0,delay=0),d3.select(this).style("stroke","black").style("stroke-width",2),n=this.id.split("id").pop(),l(this))}),p.append("text").attr("x",24).attr("y",9).attr("dy",".35em").style("text-anchor","start").text(function(a){return a}))}function draw_xy_chart(){var b=Math.pow,c=Math.abs;function a(a){a.each(function(a){var d=Math.max,e=[];notes.length&&$.each(notes,function(a,b){b.label&&e.push(b.label)});var f=e.length&&40||0;if(xlabel)var g=50;else var g=20;var h={top:20,right:.1*width,bottom:g,left:.1*width},j=width-h.left-h.right,l=height-h.top-h.bottom,m=d3.select(this).attr("width",width).attr("height",height).append("g").attr("transform","translate("+h.left+","+h.top+")"),o=d3.scaleOrdinal(d3.schemeCategory10),q=[],r=[],s=[],t=[];if("bar"===scatter){var u=a.color,v=xlimits[0]||d3.min(a.data),w=xlimits[1]||d3.max(a.data);switch(xscale){case"time":var x=d3.scaleTime().range([0,j]).domain([v,w]);break;case"linear":var x=d3.scaleLinear().range([0,j]).domain([v,w]);}var y=d3.histogram().value(function(a){return a}).domain([d3.min(a.data),d3.max(a.data)]).thresholds(x.ticks(binning))(a.data),z=d3.scaleLinear().domain([0,d3.max(y,function(a){return a.length})]).range([l,0])}else{var v=xlimits[0]||d3.min(a,function(a){return d3.min(a.x)}),w=xlimits[1]||d3.max(a,function(a){return d3.max(a.x)});switch(xscale){case"inv-square":var x=d3.scalePow().exponent(-2).range([0,j]).domain([w,v]);break;case"pow":var x=d3.scalePow().range([0,j]).domain([v,w]);break;case"log":var x=d3.scaleLog().range([0,j]).domain([v,w]);break;case"identity":var x=d3.scaleIdentity().range([0,j]).domain([v,w]);break;case"time":var x=d3.scaleTime().range([0,j]).domain([v,w]);break;case"linear":var x=d3.scaleLinear().range([0,j]).domain([v,w]);break;case"inverse":var x=d3.scaleLinear().range([0,j]).domain([w,v]);}switch(interpolation){case"cardinal":var A=d3.curveCardinal;break;case"step":var A=d3.curveStep;break;case"step-after":var A=d3.curveStepAfter;break;case"step-before":var A=d3.curveStepBefore;break;case"basis":var A=d3.curveBasis;break;case"linear":var A=d3.curveLinear;}for(var B=0;B<a.length;B++)a[B].color=o(B),a[B].y1&&(q=q.concat(a[B].y1),s.push(a[B])),a[B].y2&&(r=r.concat(a[B].y2),t.push(a[B]));var z=d3.scaleLinear().range([l-f,0]).domain([y1limits[0]||d3.min(q),y1limits[1]||d3.max(q)]),n=d3.scaleLinear().range([l-f,0]).domain([y2limits[0]||d3.min(r),y2limits[1]||d3.max(r)])}var C=d3.axisBottom().scale(x).tickSize(-l);if("inv-square"===xscale){var D=inv_sqrt(Array.cleanspace(b(w,-2),b(v,-2),8));C.tickValues(D).tickFormat(d3.format(".3"))}else"time"===xscale&&timeformat&&C.ticks(7).tickFormat(d3.timeFormat(timeformat));var E=d3.axisLeft().scale(z).tickSize(-j),F=d3.axisRight().scale(n);if(m.append("g").attr("class","x axis").attr("transform","translate(0,"+l+")").call(C),m.append("text").attr("transform","translate("+j/2+","+(height-h.bottom/2)+")").style("text-anchor","middle").text(xlabel),m.append("g").attr("class","y axis").call(E).append("text").attr("transform","translate(0,"+l/2+"), rotate(-90)").attr("y",6).attr("dy","-3.5em").style("text-anchor","middle").attr("fill",function(){return 1<s.length||!s.length?"#000000":s.length&&s[0].color}).text(y1label),"bar"===scatter){var G=m.selectAll(".bar").data(y).enter().append("g").attr("class","bar").attr("fill",u).attr("transform",function(a){return"translate("+x(a.x0)+","+z(a.length)+")"});G.append("rect").attr("x",1).attr("title",function(a){return"time"===xscale&&timeformat?d3.timeFormat(timeformat)(a.x0)+"-"+d3.timeFormat(timeformat)(a.x1)+": "+a.length+"entries":a.x0+"-"+a.x1+": "+a.length+" entries"}).attr("width",x(y[0].x1)-d(0,x(y[0].x0)-1)).attr("height",function(a){return l-z(a.length)})}else{for(var H=[],I=[],B=0;B<a.length;B++)a[B].y1?H.push(d3.line().curve(A).x(function(a){return x(a[0])}).y(function(a){return z(a[1])})):a[B].y2&&I.push(d3.line().curve(A).x(function(a){return x(a[0])}).y(function(a){return n(a[1])}));r.length&&m.append("g").attr("class","y axis").attr("transform","translate("+j+", 0)").call(F).append("text").attr("transform","translate(0,"+l/2+"), rotate(-90)").attr("y",55).attr("dy",0).style("text-anchor","middle").attr("fill",function(){return 1<t.length?"#000000":t[0].color}).text(y2label);for(var J=m.selectAll(".d3_xy1_chart_line").data(s.map(function(a){return d3.zip(a.x,a.y1)})).enter().append("g").attr("class","d3_xy1_chart_line"),K=m.selectAll(".d3_xy2_chart_line").data(t.map(function(a){return d3.zip(a.x,a.y2)})).enter().append("g").attr("class","d3_xy2_chart_line"),B=0;B<H.length;B++)if("line"===scatter)J.append("path").attr("class","line").attr("d",function(a){return H[B](a)}).attr("data-legend",function(a,b){return s[b].label||null}).attr("stroke",function(a,b){return s[b].color}).attr("fill","none");else for(k=0;k<s.length;k++)var L=s[k].x.map(function(a,b){return[a,s[k].y1[b]]}),M=m.selectAll("dot").data(L).enter().append("circle").attr("r",2).attr("cx",function(a){return x(a[0])}).attr("cy",function(a){return z(a[1])}).attr("fill",function(){return s[k].color});for(var B=0;B<I.length;B++)if("line"===scatter)K.append("path").attr("class","line").attr("d",function(a){return I[B](a)}).attr("data-legend",function(a,b){return t[b].label||null}).attr("stroke",function(a,b){return t[b].color}).attr("fill","none");else for(k=0;k<t.length;k++)var L=t[k].x.map(function(a,b){return[a,t[k].y2[b]]}),M=m.selectAll("dot").data(L).enter().append("circle").attr("r",2).attr("cx",function(a){return x(a[0])}).attr("cy",function(a){return n(a[1])}).attr("fill",function(){return t[k].color});legend=m.append("g").attr("class","legend").attr("transform","translate(50,30)").call(d3.legend);var N=m.append("g").attr("class","mouse-over-effects");N.append("path").attr("class","mouse-line").style("stroke","#333").style("stroke-width","0.5px").style("opacity","0");$(this).find(".line");if(t){for(var O=[],B=0;B<s.length;B++)O.push({x:s[B].x,y1:s[B].y1});for(var B=0;B<t.length;B++)O.push({x:t[B].x,y1:t[B].y2,scale:n});var P=N.selectAll(".mouse-per-line").data(O).enter().append("g").attr("class","mouse-per-line")}else var P=N.selectAll(".mouse-per-line").data(a).enter().append("g").attr("class","mouse-per-line");P.append("circle").attr("r",2).style("fill","none").style("stroke-width","4px").style("opacity","0"),P.append("text").attr("transform","translate(10,3)");var Q=m.append("text").attr("transform","translate("+(j-3)+", "+(l-3)+")").style("text-anchor","end").style("opacity","0");N.append("rect").attr("width",j).attr("height",l).attr("fill","none").attr("pointer-events","all").on("mouseout",function(){m.select(".mouse-line").style("opacity","0"),m.selectAll(".mouse-per-line circle").style("opacity","0"),m.selectAll(".mouse-per-line text").style("opacity","0"),Q.style("opacity","1")}).on("mouseover",function(){m.select(".mouse-line").style("opacity","1"),m.selectAll(".mouse-per-line circle").style("opacity","1"),m.selectAll(".mouse-per-line text").style("opacity","1"),Q.style("opacity","1")}).on("mousemove",function(){var a=d3.mouse(this);m.select(".mouse-line").attr("d",function(){var b="M"+a[0]+","+l;return b+=" "+a[0]+","+0,b}),m.selectAll(".mouse-per-line").style("stroke",function(a,b){return o(b)}).attr("transform",function(b){var d=x.invert(a[0]);"time"===xscale?Q.text("X = "+d3.timeFormat(timeformat)(d)):Q.text("X = "+d.toFixed(2));var e=b.x.reduce(function(a,b){return c(b-d)<c(a-d)?b:a}),f=b.x.indexOf(e),g=b.scale||z,h=g(b.y1[f]);return d3.select(this).select("text").style("stroke","none").text(g.invert(h).toFixed(2)),"translate("+x(e)+","+h+")"})})}for(i=0;i<notes.length;i++){var R=notes[i].xstart&&x(notes[i].xstart)||notes[i].x&&x(notes[i].x)||0,S=notes[i].xend&&x(notes[i].xend)||notes[i].x&&x(notes[i].x)||0,T=notes[i].ystart&&z(notes[i].ystart)||0,U=notes[i].yend&&z(notes[i].yend)||l-f;m.append("path").attr("class",notes[i].label+" "+(notes[i]["class"]||"")+" "+(null!==notes[i].display&&(!0===notes[i].display&&"visible "||"hidden"))||"visible").style("stroke",notes[i].color||"#333").attr("d",function(){var a="M"+R+","+U;return a+=" "+S+","+T,a}),m.append("text").attr("class",notes[i].label+" "+(notes[i]["class"]||"")+" "+(null!==notes[i].display&&(!0===notes[i].display&&"visible "||"hidden"))||"visible").text(notes[i].label).style("fill",notes[i].color||"#333").attr("transform","translate("+(R+3)+","+(z(0)+f/2)+"), rotate(-90)").style("text-anchor","middle")}})}return a.width=function(b){return arguments.length?(width=b,a):width},a.height=function(b){return arguments.length?(height=b,a):height},a.xlabel=function(b){return arguments.length?(xlabel=b,a):xlabel||""},a.y1label=function(b){return arguments.length?(y1label=b,a):y1label},a.y2label=function(b){return arguments.length?(y2label=b,a):y2label},a.xscale=function(b){return arguments.length?(xscale=b,a):xscale},a.scatter=function(b){return arguments.length?(scatter=b,a):scatter},a.notes=function(b){return arguments.length?(notes=b,a):notes||[]},a.interpolation=function(b){return arguments.length?(interpolation=b,a):interpolation},a.xlimits=function(b){return arguments.length?(xlimits=b,a):xlimits||[null,null]},a.y1limits=function(b){return arguments.length?(y1limits=b,a):y1limits||[null,null]},a.y2limits=function(b){return arguments.length?(y2limits=b,a):y2limits||[null,null]},a.binning=function(b){return arguments.length?(binning=b,a):binning},a.timeformat=function(b){return arguments.length?(timeformat=b,a):timeformat},a}function build_report(a,b){var c=new showdown.Converter;$.each(b.details,function(b,d){var e=$(a).append("<section class=\"container\" id=\"section-"+b+"\"></section>").children(":last-child");d.title&&e.append("<div class='col-12'><h3 class='section-title' >"+d.title+"</h3></div>"),e.addClass(d.style||""),d.description&&e.append("<div class='col-12'>"+c.makeHtml(d.description)+"</div>"),$.each(d.content,function(a,d){var f=e.append("<div class='col-12' id='entry-"+b+"-"+a+"'></div>").children(":last-child");if(f.addClass(d.style||""),d.title&&!d.kind&&f.append("<h4>"+d.title+"</h4>"),d.description&&f.append("<div class='description'>"+c.makeHtml(d.description)+"</div>"),"table"===d.kind){if(d.data){var g=$("<table id='table-"+b+"-"+a+"' class='table table-hover table-sm'></table>"),h=$("<thead></thead>"),j=$("<tbody></tbody>");$.each(d.data,function(a,b){if(b){var c=$("<tr></tr>");for(k=0;k<b.length;k++){if(0===k&&"column"===d.header||0===a&&"row"===d.header)var e=$("<th></th>").text(b[k]);else var e=$("<td></td>").text(b[k]);c.append(e)}"row"===d.header&&0===a?h.append(c):j.append(c)}}),d.title&&g.append("<caption class='text-center'>Table "+($("table").length+1)+". "+d.title+"</caption>"),g.append(h),g.append(j),f.append(g)}}else if("histogram"===d.kind){$("#entry-"+b+"-"+a).append("<figure id='figure-"+b+"-"+a+"'></figure>");var m=d.data.data,n={top:20,right:20,bottom:50,left:40},o=$("#figure-"+b+"-"+a).width()-n.left-n.right,p=o/2,q=d3.scaleBand().range([0,o]).padding(.1),l=d3.scaleLinear().range([p,0]),r=d3.scaleOrdinal(d.data.colors||["#883A6A","#C27844","#551863","#CBEFB6","#5BC0DE"]),s=d3.select("#figure-"+b+"-"+a).append("svg").attr("id","plot-"+b+"-"+a).attr("width",o+n.left+n.right).attr("height",p+n.top+n.bottom).append("g").attr("transform","translate("+n.left+","+n.top+")");drawStackChart(m,d.data["x-label"],s,r,q,l,p),d.title&&$("#figure-"+b+"-"+a).append("<figcaption class='text-center'>Figure "+($("figure").length+1)+". "+d.title+"</figcaption>")}else if("lineplot"===d.kind||"scatterplot"===d.kind||"barchart"===d.kind){$("#entry-"+b+"-"+a).append("<figure id='figure-"+b+"-"+a+"'></figure>");var m=[],t=d.data["x-label"]||d.data.x&&d.data.x.shift()||null,u=d.data["x-scale"]||"linear",v=d.data["x-limits"]||[null,null],w=d.data["y1-limits"]||[null,null],x=d.data["y2-limits"]||[null,null],y=d.data.interpolation||"linear",z=d.data.annotations||[],A=d.data.bins||50,B=d.data["time-format"]||null,C="",D="";"barchart"===d.kind?(m={data:d.data.data,color:d.data.color},"time"==u&&$.each(m.data,function(a,b){m.data[a]=new Date(b)})):("time"==u&&$.each(d.data.x,function(a,b){d.data.x[a]=new Date(b)}),$.each(d.data.y1,function(a,b){C=b.shift(),m.push({label:C,x:d.data.x,y1:b})}),$.each(d.data.y2,function(a,b){D=b.shift(),m.push({label:D,x:d.data.x,y2:b})}));var o=$("#figure-"+b+"-"+a).width();C=d.data["y1-label"]||C,D=d.data["y2-label"]||D;var E=draw_xy_chart().width(o).height(o/2).xlabel(t).y1label(C).y2label(D).xlimits(v).y1limits(w).y2limits(x).xscale(u).notes(z).binning(A).timeformat(B).interpolation(y).scatter("scatterplot"===d.kind&&"scatter"||"lineplot"===d.kind&&"line"||"barchart"===d.kind&&"bar"),F=d3.select("#figure-"+b+"-"+a).append("svg").attr("id","plot-"+b+"-"+a).datum(m).call(E);d.title&&$("#figure-"+b+"-"+a).append("<figcaption class='text-center'>Figure "+($("figure").length+1)+". "+d.title+"</figcaption>")}else if("pie"===d.kind||"gauge"===d.kind){$("#entry-"+b+"-"+a).append("<figure id='figure-"+b+"-"+a+"'></figure>");var m=[],o=f.width(),G=0;$.each(d.data,function(a,b){(d.data[a].start||G)!=G&&(m.push({start:G,value:d.data[a].start-G,color:"#ffffff"}),G+=d.data[a].start-G),b.start=b.start||G,m.push(b),G+=d.data[a].value});var H=draw_pie_chart().width(o).height(o).innerRadius("gauge"===d.kind&&.5||0),F=d3.select("#figure-"+b+"-"+a).append("svg").attr("id","plot-"+b+"-"+a).attr("class","gauge").datum(m).call(H);d.title&&$("#figure-"+b+"-"+a).append("<figcaption class='text-center'>Figure "+($("figure").length+1)+". "+d.title+"</figcaption>")}d.notes&&f.append("<div class='notes pb-4'>"+c.makeHtml(d.notes)+"</div>")})})}