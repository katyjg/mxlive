{% load applicationcontent_tags %}

<div class="calendar">
    {% load schedule_extras %}
    <!-- Header -->
    <h2>
        <span>Week of
        	{% for day in calendar %}
        		{% if forloop.first %}
        			{{day.0|cut:"/"|slice:"4:7"}}. {{day.0|cut:"/"|slice:"-2:"}} - {% endif %}
        		{% if forloop.last %}
        			{% ifnotequal calendar.0.0|slice:"4:7" day.0|slice:"4:7" %}
        				{{day.0|slice:"4:7"}}.
        			{% endifnotequal %}
        			{{day.0|cut:"/"|slice:"-2:"}}, {{day.5|slice:":4"}}{% endif %}
        	{% endfor %}
        </span>
    </h2>
    
    <!-- Navigation Stuff -->
    <div>
    {% if admin %}
        <a class="prev" href='{% url "admin-anyweek" day=prev_week %}' title="Previous Week">
            <img src="/static/img/prev.png" alt="Prev">
        </a>
        <a class="current" href='{% url "admin-thisweek" %}'>Back to Current Week</a>
        <a class="next" href='{% url "admin-anyweek" day=next_week %}' title="Next Week">
            <img src="/static/img/next.png" alt="Next">
        </a>
    {% else %}{% if not staff %}
        <a class="prev" href='{% app_reverse "scheduler-anyweek" "scheduler.urls" day=prev_week %}' title="Previous Week">
            <img src="/static/img/prev.png" alt="Prev">
        </a>
        <a class="current" href='{% app_reverse "scheduler-thisweek" "scheduler.urls" %}'>Back to Current Week</a>
        <a class="next" href='{% app_reverse "scheduler-anyweek" "scheduler.urls" day=next_week %}' title="Next Week">
            <img src="/static/img/next.png" alt="Next">
        </a>
    {% else %}
        <a class="prev" href='{% url "staff-anyweek" day=prev_week %}' title="Previous Week">
            <img src="/static/img/prev.png" alt="Prev">
        </a>
        <a class="current" href='{% url "staff-thisweek" %}'>Back to Current Week</a>
        <a class="next" href='{% url "staff-anyweek" day=next_week %}' title="Next Week">
            <img src="/static/img/next.png" alt="Next">
        </a>
    {% endif %}{% endif %}
    </div>
    
    <!-- Calendar Starts -->
    <table>
        <thead>
            <tr>
                <th class="date emph" scope="col" abbr="Date">Date</th>
                <th class="date emph" scope="col" abbr="Shift">Shift</th>
                    {% for bl in beamlines %}
                        <th class="beamline emph" scope="col" abbr="{{bl.name}}">{{bl.name}}</th>
                    {% endfor %}
                <th class="date emph" scope="col" abbr="On Call">Local Contact</th>
            </tr>
        </thead>
        <tbody>
        
        <!-- Cycle through the rows -->
        {% for day in calendar %}
            <tr>
            	<!-- "Date" column -->
                <td rowspan=3 class="column1 emph {% ifequal day.0 today.0 %}today{% endifequal %}">{{day.0}}</td>
                
                <!-- Cycle through beam modes for the day -->
                {% for mode in day.3.0 %}{% with forloop.counter0 as index %}
                    
                    <!-- "Shift" column -->
                    <td class="{% ifequal day.0 today.0 %}today{% endifequal %} 
                               td-time {% if mode %}{{mode}}{% else %}
                               {% if day.4|get_webmode:index %}{{ day.4|get_webmode:index }}{% else %}
                               {% if admin %}update {% endif %}{% endif %}{% endif %} tdcenter
                               {% if forloop.last %}emph{% endif %}">
                        {% if admin %}{% if not mode %}{% if not day.4|get_webmode:index %}
                            <div class="modal-form update-tool" 
                                   href="{% url 'bl-add-mode' %}?start_date={{day.5}}&first_shift={{index}}"
                                   title="Update beam status">&nbsp;</div>
                        {% endif %}{% endif %}{% endif %}
                        {% cycle '08:00-16:00' '16:00-24:00' '00:00-08:00' %}
                        <span class="{% ifequal day.0 today.0 %}{% ifequal index today.1 %}now {% endifequal %}{% endifequal %}">&nbsp;</span>
                    </td>
                        
                    <!-- Cycle through beamlines -->
                    {% for visit in day.1 %}{% with beamlines|get_webmode:forloop.counter0 as bl %}
                    
                    	<!-- "bl" column -->
                        <td class="{% ifequal day.0 today.0 %}today {% ifequal index today.1 %}now {% endifequal %}{% endifequal %} 
                            {% if forloop.parentloop.last %}emph{% endif %}
                            {% if admin %}
                                del {% if mode %}{{mode}}{% else %}{{ day.4|get_webmode:index }}{% endif %}
                                {% if visit|get_webmode:index %}
                                	{% with visit|get_webmode:index|get_webmode:0|get_webmode:1 as vis %}
                                    	{% if vis.maintenance %}beam-main{% endif %}
                                	{% endwith %}
                               	{% else %}
                                     modal-form link-cell
                            {% endif %}"
                                {% if not visit|get_webmode:index %}
                                 	href="{% url 'bl-add-visit' %}?beamline={{bl.pk}}&start_date={{day.5}}&first_shift={{forloop.parentloop.counter0}}"
                                 	title="Add new visit"
                            	{% endif %}
            				{% else %}
                             	{% if mode %}{{mode}}{% else %}{{ day.4|get_webmode:index }}{% endif %}
                                {% if visit|get_webmode:index %}
                                	{% with visit|get_webmode:index|get_webmode:0|get_webmode:1 as vis %}
                                     	{% if vis.maintenance %}beam-main{% endif %}
                                	{% endwith %}
                                {% endif %}"
                            {% endif %}>
                            
                            <!-- Print text in the table cells -->
                            {% if mode|find_in:"FacilityRepair" and not staff %}
                            	Facility Repairs
                            {% else %}
                            	{% if visit|get_webmode:index %}{% with visit|get_webmode:index|get_webmode:0|get_webmode:1 as vis %}
             		                <!-- Notification icon -->
             		                {% if staff %}
	                      				{% ifequal day.0 vis.start_date|date:"D M/d" %}{% ifequal index vis.first_shift %}
	                      					{% if not vis.sent %}
	                      						{% if vis.notify %}<div class="notify-icon"></div>{% endif %}
	                      					{% else %}
	                      						<div class="notify-done-icon"></div>
	                      					{% endif %}
	                      				{% endifequal %}{% endifequal %}
	                      			{% endif %}
                               		<!-- Add icons for remote or mail-in collection -->
                               		{% if staff or not vis.maintenance %}{% if staff or not mode|find_in:"FacilityRepair" %}
                                			{% if vis.remote %}
                                				<div class="remote-icon" title="Remote Access"></div>
                                			{% else %}{% if vis.mail_in %}
                                				<div class="mail-icon" title="Mail-In Access"></div>
                                			{% endif %}{% endif %}
                               		{% endif %}{% endif %}
                               
                               		<!-- Editable from admin side -->
                               		{% if admin %}
                               			<var class="modal-form {% if not vis.proposal.expiration %}inactive{% endif %}"
                                  				 href="{% url 'bl-edit-visit' vis.pk %}" title="Edit this visit">
                                  		{% endif %}
                                  
                               		{% if not vis.maintenance %}
                               		      {% comment "" %}
                                			{% if vis.purchased %}Purchased 
                                    			{% if not staff %}
                                    				Access
                                    			{% else %}
                                    				<text class="admin {% if not vis.proposal.expiration %}inactive{% endif %}">
                                    					- {{ vis.proposal_display }} {% if vis.description %}({{vis.description}}){% endif %}
                                    				</text>
                                    			{% endif %}
                                			{% else %}
                                    			{% if vis.proposal %}
                                    				{{ vis.proposal.last_name }}
                                    				{% if staff %}
                                    					<text class="admin {% if not vis.proposal.expiration %}inactive{% endif %}">
                                    						, {{ vis.proposal.first_name }} {% if vis.description %}({{vis.description}}){% endif %}
                                        				</text>
                                        			{% endif %}
                                       			{% else %}
                                       				{{vis.description }}
                                       			{% endif %}
                                    			{% if staff %}
                                    				{% if vis.proposal %}
                                    					<text class="admin {% if not vis.proposal.expiration %}inactive{% endif %}"> 
                                    						#{{ vis.proposal.proposal_id }}
                                    					</text>
                                    				{% endif %}
                                    			{% endif %}
                                			{% endif %}
                                		{% endcomment %}
                                            {% if vis.purchased %} 
                                    			{% if staff %}Purchased Access{% endif %}
                                    		{% endif %}
                                   			{% if vis.proposal %}
                                   				{% if staff %}<text class="admin {% if not vis.proposal.expiration %}inactive{% endif %}">{% endif %}
                                   				{{ vis.proposal.last_name }}{% if staff %}, 
                                   					{{ vis.proposal.first_name }} #{{ vis.proposal.proposal_id }} {% if vis.description %}({{vis.description}}){% endif %}</text>
                                   				{% else %}
                                   					#{{ vis.proposal.proposal_id }}
                                   				{% endif %}
                                   				
                                   			{% else %}
                                   				{{vis.description }}
                                   			{% endif %}
                                   	{% else %}
                               			Beamline Maintenance
                                   		{% if staff %}
                                   			<text class="admin {% if not vis.proposal.expiration %}inactive{% endif %}">
                                   				{{ vis.proposal.display }}
                                   			</text>
                                   		{% endif %}
                               		{% endif %}
                               
                               		<!-- Deletable from admin side -->
                               		{% if admin %}
                               			</var>
                               			<div class="modal-form delete-tool" href="{% url 'bl-delete-visit' vis.pk %}" 
                               				 title="Delete this visit">&nbsp;</div>
                                  		{% endif %}
                            	{% endwith %}{% endif %}
                            {% endif %}
                        </td>
                        {% endwith %}{% endfor %}
                        
                        <!-- "On Call" column -->
                        {% if forloop.first %}
                            <td rowspan=2 class="
                            	{% if day.2 %}oncall {% ifequal day.0 today.0 %}today{% endifequal %}"
                                {% else %}
                                    {% if not admin %}column1"
                                    {% else %}column1 modal-form link-cell" href="{% url 'bl-add-oncall' %}?date={{day.5}}"
                                    {% endif %}
                                {% endif %}>
                                {% with day.2.0.local_contact as person %}
                                	<a href="{% if admin %}
                                			 {% else %}/contact-us/#{{person.first_name}}-{{person.last_name}}{% endif %}"
                                	   title="{{person.first_name }} {{ person.last_name}}&#13;{{person.phone_number}}">
                                		{{person.initials}}</a>
                                {% endwith %}
                                {% if day.2 %}{% if admin %}
                                 	<a class="modal-form delete-tool" 
                                       href="{% url 'bl-delete-oncall' day.2.0.pk %}"
                                       title="Delete this on-call shift">&nbsp;</a>
                                {% endif %}{% endif %}
                            </td>
                        {% else %}{% if forloop.last %}
                            <td class="column1 emph"></td>
                        {% endif %}{% endif %}
               			</tr><tr>
                    {% endwith %}{% endfor %}
            	</tr>
        	{% endfor %}
        </tbody>
    </table>
</div>





